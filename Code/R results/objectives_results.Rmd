---
title: "Outlines objectives and results"
author: "K. Kraskura"
date: "`r Sys.Date()`"
output: 
  
  # pdf_document:
  html_document:
    toc: true
    toc_float: true
    toc_collapsed: true
    toc_depth: 5
    theme: united
    highlight: tango
    code_folding: hide
editor_options: 
  chunk_output_type: console
---

```{r setup1, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE)
```

<br/>


#### Fish food web bioaccumualtion model:

***Goal***:

To evaluate the model performance characterizing and predicting values in three samples systems (Joint Base Andrews, JBA, in spring and summer, and Willow Grove). In a given system, each species is described by the mean body size of all collected fish, and the system is described by the mean measured temperature, dissolved oxygen levels, organic carbon when available. No invertebrates were found or sampled in these systems.

***The model:***

The food web model is adapted from [Sun et al 2020](https://doi.org/10.1039/D2EM00047D).


***Metrics of model performance***:

1.  $R^2$ (full model, by PFAA, by Species)
  
$R^2 = 1-RSS / TSS$ 
  
$RSS = \sum (modeled_{val} - observed_{val}) $

$TSS = \sum (modeled_{val} - mean(observed_{val})) $

- RSS = residual sum squared
- TSS = total sum squared
  
2.  Model bias (MB) 

2.1 Arnot and Gobas 2004. 

$MB_i = 10^{\frac{\sum_{i=1}^{n} log (C_{model, i} / C_{obs, i})}{n}}$

$MB_j= 10^{\frac{\sum_{j=1}^{m} log (C_{model, j} / C_{obs, j})}{m}}$

- n = number of chemicals in a given species
- m = number of species for a given chemical
- C[model] = predicted PFAA concentration
- C[obs] = observed PFAA concentration
- i = number of species
- j = number of chemicals

2.2. McLeod et al 2016. 

$MB_{avg} = (log(C_{avg-pred})/log(C_{avg-model}))$

$MB_{CV} = (log(C_{CV-pred})/log(C_{CV-model}))$

- C[avg-model] = average of predicted PFAA concentration for all organisms and all PFAS
- C[avg-obs] = average of observed PFAA concentration for all organisms and all PFAS
- CV = coefficients of variation (CV) 

```{r source, warning=FALSE, message=FALSE, echo=FALSE}

library(kableExtra)
library(dplyr)
library(tidyr)
library(ggplot2)
library(reshape)
library(tibble) # needed to get named list of dataframes (in data_tables.R)
library(readxl)
library(ggformat2)
library(here)
here::i_am(path = "./Code/R results/objectives_results.Rmd")
# here()

# functions to run food web model
source(here("Code", "R model", "PFAS_bioaccum_v2.R"))
source(here("Code", "R model", "PFAS_classes_v2.R"))
source(here("Code", "R model", "PFAS_steadyState_v2.R"))
source(here("Code", "R model", "runEcosystemModels.R")) # custom written
source(here("Code", "R model", "runErrorEstimates.R")) # custom written 
source(here("Code", "R model", "data_tables.R"))
source(here("Code", "R model", "data_MonteCarlo.R")) # for sample size 

# source("../Code/PFAS_tissuePart_v2.R")

# source data tables for each objective
kRTable = read.csv(here("Data", 'export_krTable.csv'), row.names = "X", header = T)
colnames(kRTable)<-c("kr/kb", "PFAA", "chemID")

PFAS_List <- c('PFHxS','PFOS','PFOA','PFNA','PFDA','PFUA')
PFAS_labels <- c('C6 PFSA','C8 PFSA','C8 PFCA', 'C9 PFCA','C10 PFCA','C11 PFCA')
PFAA_cols <- c('PFHxS' = '#332288', # 
             'PFOS' = '#882255', # 
             'PFOA' = '#117733',
             'PFNA' = '#88CCEE',
             'PFDA' = 'orange',
             'PFUA' = '#AA4499')

p_lines <- data.frame('x' = c(0, 7),
                      'y' = c(0, 7))
p_lines$y1 <- p_lines$x-1
p_lines$y2 <- p_lines$x+1
p_lines$y3 <- p_lines$x-log10(2)
p_lines$y4 <- p_lines$x+log10(2)

```

<br/>

#### 1. Willow Grove

The model predictions for Willow Grove. This system has 3 fish species, and was sampled in fall. 

```{r willow grove all data}
source(here("Code", "R data tables", "WG.R"))

# PFAS are known in each diet item
settings_obsDiet = new_Settings(
  chooseDiet = 'forced', # known PFAA in diet
  chooseKoc = 'Koc',
  chooseDmw = "Droge",
  chooseEw = "empirical"
)

# used below in sed:water est part 
WG_inputFiles_list<-inputFiles_list
water_WG<-d.water %>%  # get the medians from the data
  select(PFHxS.m, PFOS.m, PFOA.m, PFNA.m) %>% 
  as.data.frame()
water_WG<-water_WG/1000
colnames(water_WG)<-c("PFHxS", "PFOS", "PFOA", "PFNA") 
sed_WG<-d.sed %>%  # get the medians from the data
  select(PFHxS.m, PFOS.m, PFOA.m, PFNA.m) %>% 
  as.data.frame()
colnames(sed_WG)<-c("PFHxS", "PFOS", "PFOA", "PFNA") 
obs_ratio_WG<-sed_WG/water_WG


# run the bioaccumulation model: 
AllDataWG<-runEcosystemModel(settings = settings_obsDiet,
                  inputFiles_list = inputFiles_list,
                  parameterList = c('C_B','C_WTO','C_s','k1','k2','ke','kg','kd',
                                    'Total Elimination', 'RMR',
                                    "Gill_uptake","Dietary_uptake", "Sediment_uptake",
                                    "Gill_up%", "Diet_up%", 'Sed_up%',
                                    "G_V", "G_D"),
                  PFAA_List = c('PFHxS','PFOS','PFOA','PFNA','PFDA','PFUA'),
                  dietData = inputFiles_list$dietData,
                  kRTable = kRTable,
                  min_diet_WTO_C_s = TRUE,
                  min_dietData = inputFiles_list$min_dietData,
                  max_diet_WTO_C_s = TRUE, 
                  max_dietData = inputFiles_list$max_dietData)

# PFAS in each diet item are calculated from trophic transfer
settings_modelDiet = new_Settings(
  chooseDiet = 'default',
  chooseKoc = 'Koc',
  chooseDmw = "Droge", # default = "Droge", or use "calculated" 
  chooseEw = "empirical", # default = 'empirical', or use "beta#", where:
  # must be in format: beta#, #beta [# = numeric var, no spaces, no special char]"
)

AllDataWG_fw<-runEcosystemModel(settings = settings_modelDiet,
                  inputFiles_list = inputFiles_list,
                  parameterList = c('C_B','C_WTO','C_s','k1','k2','ke','kg','kd',
                                    'Total Elimination', 'RMR',
                                    "Gill_uptake","Dietary_uptake", "Sediment_uptake",
                                    "Gill_up%", "Diet_up%", 'Sed_up%',
                                    "G_V", "G_D"),
                  PFAA_List = c('PFHxS','PFOS','PFOA','PFNA','PFDA','PFUA'),
                  dietData = inputFiles_list$dietData,
                  kRTable = kRTable,
                  min_diet_WTO_C_s = TRUE,
                  min_dietData = inputFiles_list$min_dietData,
                  max_diet_WTO_C_s = TRUE, 
                  max_dietData = inputFiles_list$max_dietData)

# PFAS in each diet item are calculated from trophic transfer
settings_modelDiet = new_Settings(
  chooseDiet = 'zero',
  chooseKoc = 'Koc',
  chooseDmw = "Droge", # default = "Droge", or use "calculated" 
  chooseEw = "empirical", # default = 'empirical', or use "beta#", where:
  # must be in format: beta#, #beta [# = numeric var, no spaces, no special char]"
)

AllDataWG_zero<-runEcosystemModel(settings = settings_modelDiet,
                  inputFiles_list = inputFiles_list,
                  parameterList = c('C_B','C_WTO','C_s','k1','k2','ke','kg','kd',
                                    'Total Elimination', 'RMR',
                                    "Gill_uptake","Dietary_uptake", "Sediment_uptake",
                                    "Gill_up%", "Diet_up%", 'Sed_up%',
                                    "G_V", "G_D"),
                  PFAA_List = c('PFHxS','PFOS','PFOA','PFNA','PFDA','PFUA'),
                  dietData = inputFiles_list$dietData,
                  kRTable = kRTable,
                  min_diet_WTO_C_s = TRUE,
                  min_dietData = inputFiles_list$min_dietData,
                  max_diet_WTO_C_s = TRUE, 
                  max_dietData = inputFiles_list$max_dietData)

```

```{r willow grove same date samping}
source(here("Code", "R data tables", "WG_sameDate.R"))

# PFAS are known in each diet item
settings_obsDiet = new_Settings(
  chooseDiet = 'forced',
  chooseKoc = 'Koc',
  chooseDmw = "Droge",
  chooseEw = "empirical"
)

# run the bioaccumulation model: 
AllDataWG2<-runEcosystemModel(settings = settings_obsDiet,
                  inputFiles_list = inputFiles_list,
                  parameterList = c('C_B','C_WTO','C_s','k1','k2','ke','kg','kd',
                                    'Total Elimination', 'RMR', "Gill_uptake",
                                    "Gill_up%", "Diet_up%",
                                    "Dietary_uptake", "G_V", "G_D"),
                  PFAA_List = c('PFHxS','PFOS','PFOA','PFNA','PFDA','PFUA'),
                  dietData = inputFiles_list$dietData,
                  kRTable = kRTable,
                  min_diet_WTO_C_s = TRUE,
                  min_dietData = inputFiles_list$min_dietData,
                  max_diet_WTO_C_s = TRUE, 
                  max_dietData = inputFiles_list$max_dietData)

# PFAS in each diet item are calculated from trophic transfer
settings_modelDiet = new_Settings(
  chooseDiet = 'default',
  chooseKoc = 'Koc',
  chooseDmw = "Droge", # default = "Droge", or use "calculated" 
  chooseEw = "empirical", # default = 'empirical', or use "beta#", where:
  # must be in format: beta#, #beta [# = numeric var, no spaces, no special char]"
)

AllDataWG_fw2<-runEcosystemModel(settings = settings_modelDiet,
                  inputFiles_list = inputFiles_list,
                  parameterList = c('C_B','C_WTO','C_s','k1','k2','ke','kg','kd',
                                    'Total Elimination', 'RMR', "Gill_uptake",
                                    "Gill_up%", "Diet_up%",
                                    "Dietary_uptake", "G_V", "G_D"),
                  PFAA_List = c('PFHxS','PFOS','PFOA','PFNA','PFDA','PFUA'),
                  dietData = inputFiles_list$dietData,
                  kRTable = kRTable,
                  min_diet_WTO_C_s = TRUE,
                  min_dietData = inputFiles_list$min_dietData,
                  max_diet_WTO_C_s = TRUE, 
                  max_dietData = inputFiles_list$max_dietData)

```

```{r wg model bias tables, echo = FALSE, message=FALSE, warning=FALSE}

wg1_error <- estimate_error(MetricData = AllDataWG, DataID = "wg_forced")
wg1_error_fw <- estimate_error(MetricData = AllDataWG_fw, DataID = "wg_fw")
wg1_error_zero <- estimate_error(MetricData = AllDataWG_zero, DataID = "wg_zero")

wg1_error2 <- estimate_error(MetricData = AllDataWG2, DataID = "wg_forced_sameDay")
wg1_error_fw2 <- estimate_error(MetricData = AllDataWG_fw2, DataID = "wg_fw_sameDay")
# MBj, MBi, MB, rsq,  r2_pfaa, r2_species
```

```{r willow grove data output and plots, fig.cap= "Figure. 1"}
AllDataWG <- AllDataWG[!c(AllDataWG$PFAA == "PFUA" | AllDataWG$PFAA == "PFDA"),]
AllDataWG_fw <- AllDataWG_fw[!c(AllDataWG_fw$PFAA == "PFUA" | AllDataWG_fw$PFAA == "PFDA"),]
AllDataWG_zero <- AllDataWG_zero[!c(AllDataWG_zero$PFAA == "PFUA" | AllDataWG_zero$PFAA == "PFDA"),]
AllDataWG2 <- AllDataWG2[!c(AllDataWG2$PFAA == "PFUA" | AllDataWG2$PFAA == "PFDA"),]
AllDataWG_fw2 <- AllDataWG_fw2[!c(AllDataWG_fw2$PFAA == "PFUA" | AllDataWG_fw2$PFAA == "PFDA"),]

p1<-ggplot(data = AllDataWG, aes(x = log_ngkg_re, y = Obs_logngkg, color = PFAA))+
    geom_line(data = p_lines, mapping = aes(x = x, y = y),
              linetype = 1, linewidth = 0.5, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y1),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y2),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y3),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y4),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_errorbar(aes(ymin = Obs_logngkg - Obs_logngkg_Lo, ymax = Obs_logngkg + Obs_logngkg_Up), linewidth = 0.5) +
    geom_errorbarh(aes(xmin = log_ngkg_re - logngkg_re_Lo, xmax = log_ngkg_re + logngkg_re_Up), linewidth = 0.5) +
    geom_point(pch = 19, size = 3)+
    theme_bw()+
    scale_color_manual(values = PFAA_cols)+
    ggtitle(label = 'forced diet')+
    annotate(geom = "text", label = bquote(R^2 == .(round(wg1_error[[3]], 3))),
             x = 0.2, y = 7, size = 4, hjust = 0)+
    annotate(geom = "text", label = bquote(MB[avg] == .(round(wg1_error[[1]], 3))),
             x = 0.2, y = 6, size = 4, hjust = 0)+
    xlab('Modeled log PFAA (ng/kg)')+
    ylab('Measured log PFAA (ng/kg)')+
    # coord_cartesian(ylim = c(2,6.5), xlim = c(2,6.5))+
    theme(legend.position = "none")
# p1_fish

p2<-ggplot(data = AllDataWG_fw, aes(x = log_ngkg_re, y = Obs_logngkg, color = PFAA))+
    geom_line(data = p_lines, mapping = aes(x = x, y = y),
              linetype = 1, linewidth = 0.5, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y1),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y2),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y3),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y4),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_errorbar(aes(ymin = Obs_logngkg - Obs_logngkg_Lo, ymax = Obs_logngkg + Obs_logngkg_Up), linewidth = 0.5) +
    geom_errorbarh(aes(xmin = log_ngkg_re - logngkg_re_Lo, xmax = log_ngkg_re + logngkg_re_Up), linewidth = 0.5) +
    geom_point(pch = 19, size = 3)+
    theme_bw()+
    scale_color_manual(values = PFAA_cols)+
    annotate(geom = "text", label = bquote(R^2 == .(round(wg1_error_fw[[3]], 3))),
             x = 0.2, y = 7, size = 4, hjust = 0)+
    annotate(geom = "text", label = bquote(MG[avg] == .(round(wg1_error_fw[[1]], 3))),
             x = 0.2, y = 6, size = 4, hjust = 0)+
    ggtitle(label = 'trophic diet')+
    xlab('Modeled log PFAA (ng/kg)')+
    ylab('Measured log PFAA (ng/kg)')+
    # coord_cartesian(ylim = c(0,6.5), xlim = c(0,6.5))+
    # theme(legend.position = "right")
    theme(legend.position = "none")


p0<-ggplot(data = AllDataWG_zero, aes(x = log_ngkg_re, y = Obs_logngkg, color = PFAA))+
    geom_line(data = p_lines, mapping = aes(x = x, y = y),
              linetype = 1, linewidth = 0.5, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y1),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y2),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y3),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y4),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_errorbar(aes(ymin = Obs_logngkg - Obs_logngkg_Lo, ymax = Obs_logngkg + Obs_logngkg_Up), linewidth = 0.5) +
    geom_errorbarh(aes(xmin = log_ngkg_re - logngkg_re_Lo, xmax = log_ngkg_re + logngkg_re_Up), linewidth = 0.5) +
    geom_point(pch = 19, size = 3)+
    theme_bw()+
    scale_color_manual(values = PFAA_cols)+
    ggtitle(label = 'zero diet')+
    xlab('Modeled log PFAA (ng/kg)')+
    ylab('Measured log PFAA (ng/kg)')+
    annotate(geom = "text", label = bquote(R^2 == .(round(wg1_error_zero[[3]], 3))),
             x = 0.2, y = 7, size = 4, hjust = 0)+
    annotate(geom = "text", label = bquote(MB[avg] == .(round(wg1_error_zero[[1]], 3))),
             x = 0.2, y = 6, size = 4, hjust = 0)+
  # coord_cartesian(ylim = c(2,6.5), xlim = c(2,6.5))+
    theme(legend.position = "none")


p1.2<-ggplot(data = AllDataWG2, aes(x = log_ngkg_re, y = Obs_logngkg, color = PFAA))+
    geom_line(data = p_lines, mapping = aes(x = x, y = y),
              linetype = 1, linewidth = 0.5, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y1),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y2),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y3),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y4),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_errorbar(aes(ymin = Obs_logngkg - Obs_logngkg_Lo, ymax = Obs_logngkg + Obs_logngkg_Up), linewidth = 0.5) +
    geom_errorbarh(aes(xmin = log_ngkg_re - logngkg_re_Lo, xmax = log_ngkg_re + logngkg_re_Up), linewidth = 0.5) +
    geom_point(pch = 19, size = 3)+
    theme_bw()+
    scale_color_manual(values = PFAA_cols)+
    ggtitle(label = 'forced diet, same d')+
    xlab('Modeled log PFAA (ng/kg)')+
    ylab('Measured log PFAA (ng/kg)')+
    annotate(geom = "text", label = bquote(R^2 == .(round(wg1_error2[[3]], 3))),
             x = 0.2, y = 7, size = 4, hjust = 0)+
    annotate(geom = "text", label = bquote(MB[avg] == .(round(wg1_error2[[1]], 3))),
             x = 0.2, y = 6, size = 4, hjust = 0)+
  # coord_cartesian(ylim = c(2,6.5), xlim = c(2,6.5))+
    theme(legend.position = "none")
# p1_fish

p2.2<-ggplot(data = AllDataWG_fw2, aes(x = log_ngkg_re, y = Obs_logngkg, color = PFAA))+
    geom_line(data = p_lines, mapping = aes(x = x, y = y),
              linetype = 1, linewidth = 0.5, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y1),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y2),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y3),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y4),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_errorbar(aes(ymin = Obs_logngkg - Obs_logngkg_Lo, ymax = Obs_logngkg + Obs_logngkg_Up), linewidth = 0.5) +
    geom_errorbarh(aes(xmin = log_ngkg_re - logngkg_re_Lo, xmax = log_ngkg_re + logngkg_re_Up), linewidth = 0.5) +
    geom_point(pch = 19, size = 3)+
    theme_bw()+
    scale_color_manual(values = PFAA_cols)+
    ggtitle(label = 'trophic diet, same d')+
    xlab('Modeled log PFAA (ng/kg)')+
    ylab('Measured log PFAA (ng/kg)')+
    # coord_cartesian(ylim = c(0,6.5), xlim = c(0,6.5))+
    # theme(legend.position = "right")
    annotate(geom = "text", label = bquote(R^2 == .(round(wg1_error_fw2[[3]], 3))),
             x = 0.2, y = 7, size = 4, hjust = 0)+
    annotate(geom = "text", label = bquote(MB[avg] == .(round(wg1_error_fw2[[1]], 3))),
             x = 0.2, y = 6, size = 4, hjust = 0)+
  theme(legend.position = "none")

# p1_fish_re
legend_plot <- ggplot(data = AllDataWG_fw,
         aes(x = log_ngkg_re, y = Obs_logngkg, color = PFAA))+
  geom_point()+
  scale_color_manual(values = PFAA_cols)+
  theme(legend.title = element_blank())+
  theme_bw()

legend<-cowplot::get_legend(legend_plot)
fig1<-cowplot::plot_grid(p1, p2, p0,
                         p1.2, p2.2, legend,
                   ncol = 3,
                   nrow = 2,
                   rel_widths = c(1,1, 1),
        labels = c("A", "B", "C", "D", "E", ""))
fig1

```

PFAS predictions in Willow Grove system.
(**A**) The PFAS in each diet item were known and provided during the modelling. (**B**) The PFAS values were estimated based on the food web trophic interactions, the only known PFAS values here were in water and sediment. The dot models values when fish tissue PFAS, water, and sediment values are at their measured mean values. The food web structure was the same between both cases. The dotted lines mark log values of 2 and 10 showing where values are over- or under-predicted by a factor or 2 and 10 respectively. 

<br/> <br/>


#### 2. Joint Base Andrews (spring)

The model predictions for JBA in spring season. This system has 8 fish species, and was samples in spring. 

```{r jba spring all data}
source(here("Code", "R data tables", "JBA_spring.R"))

settings_obsDiet = new_Settings(
  chooseDiet = 'forced',
)

# used below for sed:weater estimates
JBAsp_inputFiles_list<-inputFiles_list
water_JBAsp<-d.water %>%  # get the medians from the data
  select(PFHxS.m, PFOS.m, PFOA.m, PFNA.m) %>% 
  as.data.frame()
water_JBAsp<-water_JBAsp/1000
colnames(water_JBAsp)<-c("PFHxS", "PFOS", "PFOA", "PFNA") 
sed_JBAsp<-d.sed %>%  # get the medians from the data
  select(PFHxS.m, PFOS.m, PFOA.m, PFNA.m) %>% 
  as.data.frame()
colnames(sed_JBAsp)<-c("PFHxS", "PFOS", "PFOA", "PFNA") 
obs_ratio_JBAsp<-sed_JBAsp/water_JBAsp


AllDataJBAsp<-runEcosystemModel(settings = settings_obsDiet,
                  inputFiles_list = inputFiles_list,
                  parameterList = c('C_B','C_WTO','C_s','k1','k2','ke','kg','kd',
                                    'Total Elimination', 'RMR',
                                    "Gill_uptake","Dietary_uptake", "Sediment_uptake",
                                    "Gill_up%", "Diet_up%", 'Sed_up%',
                                    "G_V", "G_D"),
                  PFAA_List = c('PFHxS','PFOS','PFOA','PFNA','PFDA','PFUA'),
                  dietData = inputFiles_list$dietData,
                  kRTable = kRTable,
                  min_diet_WTO_C_s = TRUE,
                  min_dietData = inputFiles_list$min_dietData,
                  max_diet_WTO_C_s = TRUE, 
                  max_dietData = inputFiles_list$max_dietData)


settings_modelDiet = new_Settings(
  chooseDiet = 'default'
)

AllDataJBAsp_fw<-runEcosystemModel(settings = settings_modelDiet,
                  inputFiles_list = inputFiles_list,
                  parameterList = c('C_B','C_WTO','C_s','k1','k2','ke','kg','kd',
                                    'Total Elimination', 'RMR',
                                    "Gill_uptake","Dietary_uptake", "Sediment_uptake",
                                    "Gill_up%", "Diet_up%", 'Sed_up%',
                                    "G_V", "G_D"),
                  PFAA_List = c('PFHxS','PFOS','PFOA','PFNA','PFDA','PFUA'),
                  dietData = inputFiles_list$dietData,
                  kRTable = kRTable,
                  min_diet_WTO_C_s = TRUE,
                  min_dietData = inputFiles_list$min_dietData,
                  max_diet_WTO_C_s = TRUE, 
                  max_dietData = inputFiles_list$max_dietData)

AllDataJBAsp <- AllDataJBAsp[!c(AllDataJBAsp$PFAA == "PFUA" ),]
AllDataJBAsp_fw <- AllDataJBAsp_fw[!c(AllDataJBAsp_fw$PFAA == "PFUA" ),]

# PFAS in each diet item are calculated from trophic transfer
settings_modelDiet = new_Settings(
  chooseDiet = 'zero',
  chooseKoc = 'Koc',
  chooseDmw = "Droge", # default = "Droge", or use "calculated" 
  chooseEw = "empirical", # default = 'empirical', or use "beta#", where:
  # must be in format: beta#, #beta [# = numeric var, no spaces, no special char]"
)

AllDataJBAsp_zero<-runEcosystemModel(settings = settings_modelDiet,
                  inputFiles_list = inputFiles_list,
                  parameterList = c('C_B','C_WTO','C_s','k1','k2','ke','kg','kd',
                                    'Total Elimination', 'RMR',
                                    "Gill_uptake","Dietary_uptake", "Sediment_uptake",
                                    "Gill_up%", "Diet_up%", 'Sed_up%',
                                    "G_V", "G_D"),
                  PFAA_List = c('PFHxS','PFOS','PFOA','PFNA','PFDA','PFUA'),
                  dietData = inputFiles_list$dietData,
                  kRTable = kRTable,
                  min_diet_WTO_C_s = TRUE,
                  min_dietData = inputFiles_list$min_dietData,
                  max_diet_WTO_C_s = TRUE, 
                  max_dietData = inputFiles_list$max_dietData)

```

```{r jba spring same day data}
source(here("Code", "R data tables", "JBA_spring_sameDate.R"))

settings_obsDiet = new_Settings(
  chooseDiet = 'forced',
)

AllDataJBAsp2<-runEcosystemModel(settings = settings_obsDiet,
                  inputFiles_list = inputFiles_list,
                  parameterList = c('C_B','C_WTO','C_s','k1','k2','ke','kg','kd',
                                    'Total Elimination', 'RMR', "Gill_uptake",
                                    "Gill_up%", "Diet_up%",
                                    "Dietary_uptake", "G_V", "G_D"),
                  PFAA_List = c('PFHxS','PFOS','PFOA','PFNA','PFDA','PFUA'),
                  dietData = inputFiles_list$dietData,
                  kRTable = kRTable,
                  min_diet_WTO_C_s = TRUE,
                  min_dietData = inputFiles_list$min_dietData,
                  max_diet_WTO_C_s = TRUE, 
                  max_dietData = inputFiles_list$max_dietData)


settings_modelDiet = new_Settings(
  chooseDiet = 'default'
)

AllDataJBAsp_fw2<-runEcosystemModel(settings = settings_modelDiet,
                  inputFiles_list = inputFiles_list,
                  parameterList = c('C_B','C_WTO','C_s','k1','k2','ke','kg','kd',
                                    'Total Elimination', 'RMR', "Gill_uptake",
                                    "Gill_up%", "Diet_up%", "Dietary_uptake",
                                    "Total Elimination", "G_V", "G_D"),
                  PFAA_List = c('PFHxS','PFOS','PFOA','PFNA','PFDA','PFUA'),
                  dietData = inputFiles_list$dietData,
                  kRTable = kRTable,
                  min_diet_WTO_C_s = TRUE,
                  min_dietData = inputFiles_list$min_dietData,
                  max_diet_WTO_C_s = TRUE, 
                  max_dietData = inputFiles_list$max_dietData)

AllDataJBAsp2 <- AllDataJBAsp2[!c(AllDataJBAsp2$PFAA == "PFUA" ),]
AllDataJBAsp_fw2 <- AllDataJBAsp_fw2[!c(AllDataJBAsp_fw2$PFAA == "PFUA" ),]

# DataList$PFAA<-factor(DataList$PFAA)
```

```{r jba spring model bias tables, echo = FALSE, message=FALSE, warning=FALSE}

jba_sp1_error <- estimate_error(MetricData = AllDataJBAsp, DataID = "jba_sp")
jba_sp1_error_fw <- estimate_error(MetricData = AllDataJBAsp_fw, DataID = "jba_sp_fw")
jba_sp1_error_zero <- estimate_error(MetricData = AllDataJBAsp_zero, DataID = "jba_sp_zero")

jba_sp1_error2 <- estimate_error(MetricData = AllDataJBAsp2, DataID = "jba_sp_sameDay")
jba_sp1_error_fw2 <- estimate_error(MetricData = AllDataJBAsp_fw2, DataID = "jba_sp_fw_sameDay")

```

```{r jba spring figures, fig.cap= "Figure. 1", fig.height = 8, fig.width = 8.5}

p1<-ggplot(data = AllDataJBAsp, aes(x = log_ngkg_re, y = Obs_logngkg, color = PFAA))+
    geom_line(data = p_lines, mapping = aes(x = x, y = y),
              linetype = 1, linewidth = 0.5, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y1),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y2),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y3),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y4),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_errorbar(aes(ymin = Obs_logngkg - Obs_logngkg_Lo, ymax = Obs_logngkg + Obs_logngkg_Up), size = 0.5) +
    geom_errorbarh(aes(xmin = log_ngkg_re - logngkg_re_Lo, xmax = log_ngkg_re + logngkg_re_Up), size = 0.5) +
    geom_point(pch = 19, size = 3)+
    theme_bw()+
    scale_color_manual(values = PFAA_cols)+
    ggtitle(label = 'forced diet')+
    xlab('Modeled log PFAA (ng/kg)')+
    ylab('Measured log PFAA (ng/kg)')+
    annotate(geom = "text", label = bquote(R^2 == .(round(jba_sp1_error[[3]], 3))),
             x = 0.2, y = 7, size = 4, hjust = 0)+
    annotate(geom = "text", label = bquote(MB[avg] == .(round(jba_sp1_error[[1]], 3))),
             x = 0.2, y = 6, size = 4, hjust = 0)+
  # coord_cartesian(ylim = c(2,6.5), xlim = c(2,6.5))+
    theme(legend.position = "none")
# p1_fish

p2<-ggplot(data = AllDataJBAsp_fw, aes(x = log_ngkg_re, y = Obs_logngkg, color = PFAA))+
    geom_line(data = p_lines, mapping = aes(x = x, y = y),
              linetype = 1, linewidth = 0.5, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y1),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y2),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y3),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y4),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_errorbar(aes(ymin = Obs_logngkg - Obs_logngkg_Lo, ymax = Obs_logngkg + Obs_logngkg_Up), size = 0.5) +
    geom_errorbarh(aes(xmin = log_ngkg_re - logngkg_re_Lo, xmax = log_ngkg_re + logngkg_re_Up), size = 0.5) +
    geom_point(pch = 19, size = 3)+
    theme_bw()+
    scale_color_manual(values = PFAA_cols)+
    ggtitle(label = 'trophic diet')+
    xlab('Modeled log PFAA (ng/kg)')+
    ylab('Measured log PFAA (ng/kg)')+
    annotate(geom = "text", label = bquote(R^2 == .(round(jba_sp1_error_fw[[3]], 3))),
             x = 0.2, y = 7, size = 4, hjust = 0)+
    annotate(geom = "text", label = bquote(MB[avg] == .(round(jba_sp1_error_fw[[1]], 3))),
             x = 0.2, y = 6, size = 4, hjust = 0)+
  # coord_cartesian(ylim = c(0,6.5), xlim = c(0,6.5))+
    # theme(legend.position = "right")
    theme(legend.position = "none")
# p1_fish_re

p0<-ggplot(data = AllDataJBAsp_zero, aes(x = log_ngkg_re, y = Obs_logngkg, color = PFAA))+
    geom_line(data = p_lines, mapping = aes(x = x, y = y),
              linetype = 1, linewidth = 0.5, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y1),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y2),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y3),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y4),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_errorbar(aes(ymin = Obs_logngkg - Obs_logngkg_Lo, ymax = Obs_logngkg + Obs_logngkg_Up), size = 0.5) +
    geom_errorbarh(aes(xmin = log_ngkg_re - logngkg_re_Lo, xmax = log_ngkg_re + logngkg_re_Up), size = 0.5) +
    geom_point(pch = 19, size = 3)+
    theme_bw()+
    scale_color_manual(values = PFAA_cols)+
    ggtitle(label = 'zero diet')+
    xlab('Modeled log PFAA (ng/kg)')+
    ylab('Measured log PFAA (ng/kg)')+
    annotate(geom = "text", label = bquote(R^2 == .(round(jba_sp1_error_zero[[3]], 3))),
             x = 0.2, y = 7, size = 4, hjust = 0)+
    annotate(geom = "text", label = bquote(MB[avg] == .(round(jba_sp1_error_zero[[1]], 3))),
             x = 0.2, y = 6, size = 4, hjust = 0)+
  # coord_cartesian(ylim = c(0,6.5), xlim = c(0,6.5))+
    # theme(legend.position = "right")
    theme(legend.position = "none")


# legend<-cowplot::get_legend(legend_plot)
# fig1<-cowplot::plot_grid(p1, p2, legend,
#                    ncol = 3,
#                    nrow = 1,
#                    rel_widths = c(1,1, 0.3),
#         labels = c("A", "B", ""))
# fig1

p1.2<-ggplot(data = AllDataJBAsp2, aes(x = log_ngkg_re, y = Obs_logngkg, color = PFAA))+
    geom_line(data = p_lines, mapping = aes(x = x, y = y),
              linetype = 1, linewidth = 0.5, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y1),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y2),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y3),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y4),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_errorbar(aes(ymin = Obs_logngkg - Obs_logngkg_Lo, ymax = Obs_logngkg + Obs_logngkg_Up), size = 0.5) +
    geom_errorbarh(aes(xmin = log_ngkg_re - logngkg_re_Lo, xmax = log_ngkg_re + logngkg_re_Up), size = 0.5) +
    geom_point(pch = 19, size = 3)+
    theme_bw()+
    scale_color_manual(values = PFAA_cols)+
    ggtitle(label = 'forced diet same d')+
    xlab('Modeled log PFAA (ng/kg)')+
    ylab('Measured log PFAA (ng/kg)')+
    annotate(geom = "text", label = bquote(R^2 == .(round(jba_sp1_error2[[3]], 3))),
             x = 0.2, y = 7, size = 4, hjust = 0)+
    annotate(geom = "text", label = bquote(MB[avg] == .(round(jba_sp1_error2[[1]], 3))),
             x = 0.2, y = 6, size = 4, hjust = 0)+
  # coord_cartesian(ylim = c(2,6.5), xlim = c(2,6.5))+
    theme(legend.position = "none")
# p1_fish

p2.2<-ggplot(data = AllDataJBAsp_fw2, aes(x = log_ngkg_re, y = Obs_logngkg, color = PFAA))+
    geom_line(data = p_lines, mapping = aes(x = x, y = y),
              linetype = 1, linewidth = 0.5, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y1),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y2),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y3),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y4),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_errorbar(aes(ymin = Obs_logngkg - Obs_logngkg_Lo, ymax = Obs_logngkg + Obs_logngkg_Up), size = 0.5) +
    geom_errorbarh(aes(xmin = log_ngkg_re - logngkg_re_Lo, xmax = log_ngkg_re + logngkg_re_Up), size = 0.5) +
    geom_point(pch = 19, size = 3)+
    theme_bw()+
    scale_color_manual(values = PFAA_cols)+
    ggtitle(label = 'trophic diet same d')+
    xlab('Modeled log PFAA (ng/kg)')+
    ylab('Measured log PFAA (ng/kg)')+
    annotate(geom = "text", label = bquote(R^2 == .(round(jba_sp1_error_fw2[[3]], 3))),
             x = 0.2, y = 7, size = 4, hjust = 0)+
    annotate(geom = "text", label = bquote(MB[avg] == .(round(jba_sp1_error_fw2[[1]], 3))),
             x = 0.2, y = 6, size = 4, hjust = 0)+    # coord_cartesian(ylim = c(0,6.5), xlim = c(0,6.5))+
    # theme(legend.position = "right")
    theme(legend.position = "none")


# p1_fish_re
legend_plot <- ggplot(data = AllDataJBAsp_fw,
         aes(x = log_ngkg_re, y = Obs_logngkg, color = PFAA))+
  geom_point()+
  scale_color_manual(values = PFAA_cols)+
  theme(legend.title = element_blank())+
  theme_bw()

legend<-cowplot::get_legend(legend_plot)

legend<-cowplot::get_legend(legend_plot)
fig1<-cowplot::plot_grid(p1, p2, p0,
                         p1.2, p2.2, legend,
                   ncol = 3,
                   nrow = 2,
                   rel_widths = c(1, 1, 1),
        labels = c("A", "B", "C", "D", "E", ""))
fig1
# fig1<-cowplot::plot_grid(p1, p2, legend,
#                          p1.2, p2.2, NULL,
#                    ncol = 3,
#                    nrow = 2,
#                    rel_widths = c(1,1, 0.3),
#         labels = c("A", "B", "", "D", "E", ""))
# fig1

```

PFAS predictions in JBA system in spring season. 
(**A**) The PFAS in each diet item were known and provided during the modelling. (**B**) The PFAS values were estimated based on the food web trophic interactions, the only known PFAS values here were in water and sediment. The dot models values when fish tissue PFAS, water, and sediment values are at their measured mean values. The food web structure was the same between both cases. The dotted lines mark log values of 2 and 10 showing where values are over- or under-predicted by a factor or 2 and 10 respectively. 

<br/> <br/>


#### 3. Joint Base Andrews (summer)

```{r jba summer all data, echo = FALSE, message=FALSE, warning=FALSE}
source(here("Code", "R data tables", "JBA_summer.R"))

settings_obsDiet = new_Settings(
  chooseDiet = 'forced'
)

# used below for sediment water ratio estimates
JBAsum_inputFiles_list<-inputFiles_list
water_JBAsum<-d.water %>%  # get the medians from the data
  select(PFHxS.m, PFOS.m, PFOA.m, PFNA.m) %>% 
  as.data.frame()
water_JBAsum<-water_JBAsum/1000 # original data in ng/L,  conver tto ng/mL
colnames(water_JBAsum)<-c("PFHxS", "PFOS", "PFOA", "PFNA") 
sed_JBAsum<-d.sed %>%  # get the medians from the data
  select(PFHxS.m, PFOS.m, PFOA.m, PFNA.m) %>% 
  as.data.frame()
colnames(sed_JBAsum)<-c("PFHxS", "PFOS", "PFOA", "PFNA") 
obs_ratio_JBAsum<-sed_JBAsum/water_JBAsum

AllDataJBAsum<-runEcosystemModel(settings = settings_obsDiet,
                  inputFiles_list = inputFiles_list,
                  parameterList = c('C_B','C_WTO','C_s','k1','k2','ke','kg','kd',
                                    'Total Elimination', 'RMR',
                                    "Gill_uptake","Dietary_uptake", "Sediment_uptake",
                                    "Gill_up%", "Diet_up%", 'Sed_up%',
                                    "G_V", "G_D"),
                  PFAA_List = c('PFHxS','PFOS','PFOA','PFNA','PFDA','PFUA'),
                  dietData = inputFiles_list$dietData,
                  kRTable = kRTable,
                  min_diet_WTO_C_s = TRUE,
                  min_dietData = inputFiles_list$min_dietData,
                  max_diet_WTO_C_s = TRUE, 
                  max_dietData = inputFiles_list$max_dietData)


settings_modelDiet = new_Settings(
  chooseDiet = 'default'
)

AllDataJBAsum_fw<-runEcosystemModel(settings = settings_modelDiet,
                  inputFiles_list = inputFiles_list,
                  parameterList = c('C_B','C_WTO','C_s','k1','k2','ke','kg','kd',
                                    'Total Elimination', 'RMR',
                                    "Gill_uptake","Dietary_uptake", "Sediment_uptake",
                                    "Gill_up%", "Diet_up%", 'Sed_up%',
                                    "G_V", "G_D"),
                  PFAA_List = c('PFHxS','PFOS','PFOA','PFNA','PFDA','PFUA'),
                  dietData = inputFiles_list$dietData,
                  kRTable = kRTable,
                  min_diet_WTO_C_s = TRUE,
                  min_dietData = inputFiles_list$min_dietData,
                  max_diet_WTO_C_s = TRUE, 
                  max_dietData = inputFiles_list$max_dietData)

AllDataJBAsum <- AllDataJBAsum[!c(AllDataJBAsum$PFAA == "PFUA" ),]
AllDataJBAsum_fw <- AllDataJBAsum_fw[!c(AllDataJBAsum_fw$PFAA == "PFUA" ),]


# PFAS in each diet item are calculated from trophic transfer
settings_modelDiet = new_Settings(
  chooseDiet = 'zero',
  chooseKoc = 'Koc',
  chooseDmw = "Droge", # default = "Droge", or use "calculated" 
  chooseEw = "empirical", # default = 'empirical', or use "beta#", where:
  # must be in format: beta#, #beta [# = numeric var, no spaces, no special char]"
)

AllDataJBAsum_zero<-runEcosystemModel(settings = settings_modelDiet,
                  inputFiles_list = inputFiles_list,
                  parameterList = c('C_B','C_WTO','C_s','k1','k2','ke','kg','kd',
                                    'Total Elimination', 'RMR',
                                    "Gill_uptake","Dietary_uptake", "Sediment_uptake",
                                    "Gill_up%", "Diet_up%", 'Sed_up%',
                                    "G_V", "G_D"),
                  PFAA_List = c('PFHxS','PFOS','PFOA','PFNA','PFDA','PFUA'),
                  dietData = inputFiles_list$dietData,
                  kRTable = kRTable,
                  min_diet_WTO_C_s = TRUE,
                  min_dietData = inputFiles_list$min_dietData,
                  max_diet_WTO_C_s = TRUE, 
                  max_dietData = inputFiles_list$max_dietData)

```

```{r jba summer same day data, echo = FALSE, message=FALSE, warning=FALSE}
source(here("Code", "R data tables", "JBA_summer_sameDate.R"))

settings_obsDiet = new_Settings(
  chooseDiet = 'forced'
)

AllDataJBAsum2<-runEcosystemModel(settings = settings_obsDiet,
                  inputFiles_list = inputFiles_list,
                  parameterList = c('C_B','C_WTO','C_s','k1','k2','ke','kg','kd',
                                    'Total Elimination', 'RMR',
                                    "Gill_uptake","Dietary_uptake", "Sediment_uptake",
                                    "Gill_up%", "Diet_up%", 'Sed_up%',
                                    "G_V", "G_D"),
                  PFAA_List = c('PFHxS','PFOS','PFOA','PFNA','PFDA','PFUA'),
                  dietData = inputFiles_list$dietData,
                  kRTable = kRTable,
                  min_diet_WTO_C_s = TRUE,
                  min_dietData = inputFiles_list$min_dietData,
                  max_diet_WTO_C_s = TRUE, 
                  max_dietData = inputFiles_list$max_dietData)


settings_modelDiet = new_Settings(
  chooseDiet = 'default'
)

AllDataJBAsum_fw2<-runEcosystemModel(settings = settings_modelDiet,
                  inputFiles_list = inputFiles_list,
                  parameterList = c('C_B','C_WTO','C_s','k1','k2','ke','kg','kd',
                                    'Total Elimination', 'RMR',
                                    "Gill_uptake","Dietary_uptake", "Sediment_uptake",
                                    "Gill_up%", "Diet_up%", 'Sed_up%',
                                    "G_V", "G_D"),
                  PFAA_List = c('PFHxS','PFOS','PFOA','PFNA','PFDA','PFUA'),
                  dietData = inputFiles_list$dietData,
                  kRTable = kRTable,
                  min_diet_WTO_C_s = TRUE,
                  min_dietData = inputFiles_list$min_dietData,
                  max_diet_WTO_C_s = TRUE, 
                  max_dietData = inputFiles_list$max_dietData)

AllDataJBAsum2 <- AllDataJBAsum2[!c(AllDataJBAsum2$PFAA == "PFUA" ),]
AllDataJBAsum_fw2 <- AllDataJBAsum_fw2[!c(AllDataJBAsum_fw2$PFAA == "PFUA" ),]
```

```{r jba summer model bias tables, echo = FALSE, message=FALSE, warning=FALSE}

jba_sum1_error <- estimate_error(MetricData = AllDataJBAsum, DataID = "jba_sum")
jba_sum1_error_fw <- estimate_error(MetricData = AllDataJBAsum_fw, DataID = "jba_sum_fw")
jba_sum1_error_zero <- estimate_error(MetricData = AllDataJBAsum_zero, DataID = "jba_sum_fw")

jba_sum1_error2 <- estimate_error(MetricData = AllDataJBAsum2, DataID = "jba_sum_sameDay")
jba_sum1_error_fw2 <- estimate_error(MetricData = AllDataJBAsum_fw2, DataID = "jba_sum_fw_sameDay")

```

```{r jba plots and outputs, echo = FALSE, message=FALSE, warning=FALSE, fig.cap= "Figure 3", fig.height = 8, fig.width = 8.5}

p1<-ggplot(data = AllDataJBAsum, aes(x = log_ngkg_re, y = Obs_logngkg, color = PFAA))+
    geom_line(data = p_lines, mapping = aes(x = x, y = y),
              linetype = 1, linewidth = 0.5, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y1),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y2),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y3),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y4),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_errorbar(aes(ymin = Obs_logngkg - Obs_logngkg_Lo, ymax = Obs_logngkg + Obs_logngkg_Up), size = 0.5) +
    geom_errorbarh(aes(xmin = log_ngkg_re - logngkg_re_Lo, xmax = log_ngkg_re + logngkg_re_Up), size = 0.5) +
    geom_point(pch = 19, size = 3)+
    theme_bw()+
    scale_color_manual(values = PFAA_cols)+
    ggtitle(label = 'forced diet')+
    xlab('Modeled log PFAA (ng/kg)')+
    ylab('Measured log PFAA (ng/kg)')+
    annotate(geom = "text", label = bquote(R^2 == .(round(jba_sum1_error[[3]], 3))),
             x = 0.2, y = 7, size = 4, hjust = 0)+
    annotate(geom = "text", label = bquote(MB[avg] == .(round(jba_sum1_error[[1]], 3))),
             x = 0.2, y = 6, size = 4, hjust = 0)+    # coord_cartesian(ylim = c(2,6.5), xlim = c(2,6.5))+
    theme(legend.position = "none")
# p1_fish

p2<-ggplot(data = AllDataJBAsum_fw, aes(x = log_ngkg_re, y = Obs_logngkg, color = PFAA))+
    geom_line(data = p_lines, mapping = aes(x = x, y = y),
              linetype = 1, linewidth = 0.5, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y1),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y2),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y3),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y4),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_errorbar(aes(ymin = Obs_logngkg - Obs_logngkg_Lo, ymax = Obs_logngkg + Obs_logngkg_Up), size = 0.5) +
    geom_errorbarh(aes(xmin = log_ngkg_re - logngkg_re_Lo, xmax = log_ngkg_re + logngkg_re_Up), size = 0.5) +
    geom_point(pch = 19, size = 3)+
    theme_bw()+
    scale_color_manual(values = PFAA_cols)+
    ggtitle(label = 'trophic diet')+
    xlab('Modeled log PFAA (ng/kg)')+
    ylab('Measured log PFAA (ng/kg)')+
    annotate(geom = "text", label = bquote(R^2 == .(round(jba_sum1_error_fw[[3]], 3))),
             x = 0.2, y = 7, size = 4, hjust = 0)+
    annotate(geom = "text", label = bquote(MB[avg] == .(round(jba_sum1_error_fw[[1]], 3))),
             x = 0.2, y = 6, size = 4, hjust = 0)+
  # coord_cartesian(ylim = c(0,6.5), xlim = c(0,6.5))+
    # theme(legend.position = "right")
    theme(legend.position = "none")


p0<-ggplot(data = AllDataJBAsum_zero, aes(x = log_ngkg_re, y = Obs_logngkg, color = PFAA))+
    geom_line(data = p_lines, mapping = aes(x = x, y = y),
              linetype = 1, linewidth = 0.5, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y1),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y2),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y3),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y4),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_errorbar(aes(ymin = Obs_logngkg - Obs_logngkg_Lo, ymax = Obs_logngkg + Obs_logngkg_Up), size = 0.5) +
    geom_errorbarh(aes(xmin = log_ngkg_re - logngkg_re_Lo, xmax = log_ngkg_re + logngkg_re_Up), size = 0.5) +
    geom_point(pch = 19, size = 3)+
    theme_bw()+
    scale_color_manual(values = PFAA_cols)+
    ggtitle(label = 'zero diet')+
    xlab('Modeled log PFAA (ng/kg)')+
    ylab('Measured log PFAA (ng/kg)')+
    annotate(geom = "text", label = bquote(R^2 == .(round(jba_sum1_error_zero[[3]], 3))),
             x = 0.2, y = 7, size = 4, hjust = 0)+
    annotate(geom = "text", label = bquote(MB[avg] == .(round(jba_sum1_error_zero[[1]], 3))),
             x = 0.2, y = 6, size = 4, hjust = 0)+
  # coord_cartesian(ylim = c(0,6.5), xlim = c(0,6.5))+
    # theme(legend.position = "right")
    theme(legend.position = "none")

p1.2<-ggplot(data = AllDataJBAsum, aes(x = log_ngkg_re, y = Obs_logngkg, color = PFAA))+
    geom_line(data = p_lines, mapping = aes(x = x, y = y),
              linetype = 1, linewidth = 0.5, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y1),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y2),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y3),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y4),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_errorbar(aes(ymin = Obs_logngkg - Obs_logngkg_Lo, ymax = Obs_logngkg + Obs_logngkg_Up), size = 0.5) +
    geom_errorbarh(aes(xmin = log_ngkg_re - logngkg_re_Lo, xmax = log_ngkg_re + logngkg_re_Up), size = 0.5) +
    geom_point(pch = 19, size = 3)+
    theme_bw()+
    scale_color_manual(values = PFAA_cols)+
    ggtitle(label = 'forced diet same d')+
    xlab('Modeled log PFAA (ng/kg)')+
    ylab('Measured log PFAA (ng/kg)')+
    annotate(geom = "text", label = bquote(R^2 == .(round(jba_sum1_error_fw[[3]], 3))),
             x = 0.2, y = 7, size = 4, hjust = 0)+
    annotate(geom = "text", label = bquote(MB[avg] == .(round(jba_sum1_error_fw[[1]], 3))),
             x = 0.2, y = 1, size = 4, hjust = 0)+
  # coord_cartesian(ylim = c(2,6.5), xlim = c(2,6.5))+
    theme(legend.position = "none")
# p1_fish

p2.2<-ggplot(data = AllDataJBAsum_fw, aes(x = log_ngkg_re, y = Obs_logngkg, color = PFAA))+
    geom_line(data = p_lines, mapping = aes(x = x, y = y),
              linetype = 1, linewidth = 0.5, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y1),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y2),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y3),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y4),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_errorbar(aes(ymin = Obs_logngkg - Obs_logngkg_Lo, ymax = Obs_logngkg + Obs_logngkg_Up), size = 0.5) +
    geom_errorbarh(aes(xmin = log_ngkg_re - logngkg_re_Lo, xmax = log_ngkg_re + logngkg_re_Up), size = 0.5) +
    geom_point(pch = 19, size = 3)+
    theme_bw()+
    scale_color_manual(values = PFAA_cols)+
    ggtitle(label = 'trophic diet same d')+
    xlab('Modeled log PFAA (ng/kg)')+
    ylab('Measured log PFAA (ng/kg)')+
    annotate(geom = "text", label = bquote(R^2 == .(round(jba_sum1_error_fw2[[3]], 3))),
             x = 0.2, y = 7, size = 4, hjust = 0)+
     annotate(geom = "text", label = bquote(MB[avg] == .(round(jba_sum1_error_fw2[[1]], 3))),
             x = 0.2, y = 6, size = 4, hjust = 0)+   # coord_cartesian(ylim = c(0,6.5), xlim = c(0,6.5))+
    # theme(legend.position = "right")
    theme(legend.position = "none")


# p1_fish_re
legend_plot <- ggplot(data = AllDataJBAsum_fw,
         aes(x = log_ngkg_re, y = Obs_logngkg, color = PFAA))+
  geom_point()+
  scale_color_manual(values = PFAA_cols)+
  theme(legend.title = element_blank())+
  theme_bw()

legend<-cowplot::get_legend(legend_plot)
# fig1<-cowplot::plot_grid(p1, p2, legend,
#                    ncol = 3,
#                    nrow = 1,
#                    rel_widths = c(1,1, 0.3),
#         labels = c("A", "B", ""))
# fig1

fig1<-cowplot::plot_grid(p1, p2, p0,
                         p1.2, p2.2, legend,
                   ncol = 3,
                   nrow = 2,
                   rel_widths = c(1, 1, 1),
        labels = c("A", "B", "C", "D", "E", ""))
fig1

```

PFAS predictions in JBA system in summer season. 
(**A**) The PFAS in each diet item were known and provided during the modelling. (**B**) The PFAS values were estimated based on the food web trophic interactions, the only known PFAS values here were in water and sediment. The dot models values when fish tissue PFAS, water, and sediment values are at their measured mean values. The food web structure was the same between both cases. The dotted lines mark log values of 2 and 10 showing where values are over- or under-predicted by a factor or 2 and 10 respectively. 

<br/> <br/>

#### All systems together 

```{r setup2, fig.width=9, fig.height=4.5}
AllDataJBAsp$System<-"JBA-spring"
AllDataJBAsp_fw$System<-"JBA-spring"

AllDataJBAsum$System<-"JBA-summer"
AllDataJBAsum_fw$System<-"JBA-summer"

AllDataWG$System<-"Willow Grove"
AllDataWG_fw$System<-"Willow Grove"

d<-rbind(AllDataJBAsp, AllDataJBAsum, AllDataWG)
d_fw<-rbind(AllDataJBAsp_fw, AllDataJBAsum_fw, AllDataWG_fw)
d$System<-as.factor(d$System)
d_fw$System<-as.factor(d_fw$System)

p1<-ggplot(data = d, aes(x = log_ngkg_re, y = Obs_logngkg,
                         color = PFAA,
                         shape = System))+
    geom_line(data = p_lines, mapping = aes(x = x, y = y, shape = NULL),
              linetype = 1, linewidth = 0.5, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y1, shape = NULL),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y2, shape = NULL),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y3, shape = NULL),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y4, shape = NULL),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_errorbar(aes(ymin = Obs_logngkg - Obs_logngkg_Lo,
                      ymax = Obs_logngkg + Obs_logngkg_Up), size = 0.5) +
    geom_errorbarh(aes(xmin = log_ngkg_re - logngkg_re_Lo,
                       xmax = log_ngkg_re + logngkg_re_Up), size = 0.5) +
    geom_text(mapping = aes(label = SppAlias), check_overlap = T, size = 2)+
    geom_point(size = 3)+
    # facet_grid(.~System)+
    scale_shape_manual(values = c(19, 21, 23))+
    theme_bw()+
    scale_color_manual(values = PFAA_cols)+
    ggtitle(label = 'Given PFAA diet values')+
    coord_cartesian(ylim = c(1,7), xlim = c(1,7))

ggformat(p1, y_title = ('Measured log PFAS (ng/kg)'), x_title = 'Modeled log PFAS (ng/kg)', size_text = 12, print = F)
p1<-p1+theme(legend.position = "none")

p2<-ggplot(data = d_fw, aes(x = log_ngkg_re, y = Obs_logngkg,
                            color = PFAA,
                            shape = System))+
    geom_line(data = p_lines, mapping = aes(x = x, y = y, shape = NULL),
              linetype = 1, linewidth = 0.5, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y1, shape = NULL),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y2, shape = NULL),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y3, shape = NULL),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y4, shape = NULL),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_errorbar(aes(ymin = Obs_logngkg - Obs_logngkg_Lo,
                      ymax = Obs_logngkg + Obs_logngkg_Up), size = 0.5) +
    geom_errorbarh(aes(xmin = log_ngkg_re - logngkg_re_Lo,
                       xmax = log_ngkg_re + logngkg_re_Up), size = 0.5) +
    # geom_text(mapping = aes(label = SppAlias), check_overlap = T, size = 2)+
    geom_point(size = 3)+
    # facet_grid(.~System)+
    scale_shape_manual(values = c(19, 21, 23))+
    theme_bw()+
    scale_color_manual(values = PFAA_cols)+
    ggtitle(label = 'Observed diet')+
    coord_cartesian(ylim = c(1,7), xlim = c(1,7))

ggformat(p2, y_title = ('Measured log PFAS (ng/kg)'), x_title = 'Modeled log PFAS (ng/kg)', size_text = 12, print = F)
p2<-p2+theme(legend.position = "none")

# p1_fish_re
legend_plot <- ggplot(data = d,
         aes(x = log_ngkg_re, y = Obs_logngkg, color = PFAA, shape = System))+
  geom_point()+
  scale_color_manual(values = PFAA_cols)+
  scale_shape_manual(values = c(19, 21, 23))+
  theme(legend.title = element_blank())+
  theme_bw()
```

```{r legend and saving, fig.width=10, fig.height=4.6, fig.cap= "Figure 4"}
legend<-cowplot::get_legend(legend_plot)
fig1<-cowplot::plot_grid(p1, p2, legend,
                   ncol = 3,
                   nrow = 1,
                   rel_widths = c(0.9, 0.9, 0.3),
                   label_x = c(0, 0, 0),
                   label_y = c(1,1,1),
                   label_size = 12,
        labels = c("known PFAS in diet", "modeled PFAS in diet", "")
        )
fig1

# ggsave(filename = "../../Figures/fig1_oct31.png", plot = fig1, height = 3.5, width = 8)

```

PFAS predictions in all systems together. 
(**A**) The PFAS in each diet item were known and provided during the modelling. (**B**) The PFAS values were estimated based on the food web trophic interactions, the only known PFAS values here were in water and sediment. The dot models values when fish tissue PFAS, water, and sediment values are at their measured mean values. The food web structure was the same between both cases. The dotted lines mark log values of 2 and 10 showing where values are over- or under-predicted by a factor or 2 and 10 respectively. 

<br/> <br/>

#### Error estimates and model bias

```{r error estimates MB all systems together}
jba_sum1_mb<-as.data.frame(jba_sum1_error[[1]]) 
jba_sum1_mb$System<-"JBA-summer"
jba_sum1_mb_fw<-as.data.frame(jba_sum1_error_fw[[1]])
jba_sum1_mb_fw$System <- "JBA-summer"
jba_sp1_mb<-as.data.frame(jba_sp1_error[[1]])
jba_sp1_mb$System <- "JBA-spring"
jba_sp1_mb_fw<-as.data.frame(jba_sp1_error_fw[[1]])
jba_sp1_mb_fw$System <- "JBA-spring"
wg1_mb<-as.data.frame(wg1_error[[1]])
wg1_mb$System <- "Willow Grove"
wg1_mb_fw<-as.data.frame(wg1_error_fw[[1]])
wg1_mb_fw$System <- "Willow Grove"

colnames(jba_sum1_mb)<-c( "MB", "System")
colnames(jba_sum1_mb_fw)<-c( "MB", "System")
colnames(jba_sp1_mb)<-c( "MB", "System")
colnames(jba_sp1_mb_fw)<-c( "MB", "System")
colnames(wg1_mb)<-c( "MB", "System")
colnames(wg1_mb_fw)<-c( "MB", "System")

d_err<-rbind(jba_sum1_mb, jba_sp1_mb, wg1_mb)
d_err_fw<-rbind(jba_sum1_mb_fw, jba_sp1_mb_fw, wg1_mb_fw)
d_err$model<-"known diet"
d_err_fw$model<-"modeled diet"

# model CV 
jba_sum1_cv<-as.data.frame(jba_sum1_error[[2]]) 
jba_sum1_cv$System<-"JBA-summer"
jba_sum1_cv_fw<-as.data.frame(jba_sum1_error_fw[[2]])
jba_sum1_cv_fw$System <- "JBA-summer"
jba_sp1_cv<-as.data.frame(jba_sp1_error[[2]])
jba_sp1_cv$System <- "JBA-spring"
jba_sp1_cv_fw<-as.data.frame(jba_sp1_error_fw[[2]])
jba_sp1_cv_fw$System <- "JBA-spring"
wg1_cv<-as.data.frame(wg1_error[[2]])
wg1_cv$System <- "Willow Grove"
wg1_cv_fw<-as.data.frame(wg1_error_fw[[2]])
wg1_cv_fw$System <- "Willow Grove"

colnames(jba_sum1_cv)<-c( "MB", "System")
colnames(jba_sum1_cv_fw)<-c( "MB", "System")
colnames(jba_sp1_cv)<-c( "MB", "System")
colnames(jba_sp1_cv_fw)<-c( "MB", "System")
colnames(wg1_cv)<-c( "MB", "System")
colnames(wg1_cv_fw)<-c( "MB", "System")

d_cv<-rbind(jba_sum1_cv, jba_sp1_cv, wg1_cv)
d_cv_fw<-rbind(jba_sum1_cv_fw, jba_sp1_cv_fw, wg1_cv_fw)
d_cv$model<-"known diet"
d_cv_fw$model<-"modeled diet"

```

```{r model bias plots, fig.cap= "Figure 5.", include = FALSE}

err_data<-rbind(d_err, d_err_fw)
p_mb1<-ggplot(data = rbind(d_err, d_err_fw),
           aes(
               x = System, y = MB,
               shape = model, 
               group = interaction(model)))+
  geom_point(position = position_dodge(width = 0.5),
           stat = "identity", size=3)+
  scale_shape_manual(values = c(21,19))+
  # geom_hline(yintercept = 1, color = "black")+
  # geom_hline(yintercept = c(0.5, 2), color = "black", linetype = 2, linewidth = 0.1)+
  scale_color_manual(values = PFAA_cols)+
  # scale_fill_manual(values = PFAA_cols)+
  theme_bw()+
  ylim(0,1)+
  theme(legend.position = "top")+
  ylab("Model Bias (tissue conc.)")+
  theme(axis.text.x = element_text(angle = 0))+
  # coord_flip()+
  scale_x_discrete(labels = c("JBA \n spring", "JBA \n summer", "Willow \nGrove"))


# JBA spring
AllDataJBAsp_fw$spp_pfaa<-paste(AllDataJBAsp_fw$PFAA,
                                AllDataJBAsp_fw$SppAlias)

p_error<-ggplot(data = AllDataJBAsp_fw[AllDataJBAsp_fw$PFAA == "PFOS", ],
           aes(color = PFAA, 
               x = c(10^Obs_logngkg - 10^log_ngkg_re)/1000,
               y = reorder(spp_pfaa, c(10^Obs_logngkg - 10^log_ngkg_re)/1000),
               group = interaction(SppAlias, PFAA),
               size = `Diet_up%`))+
  geom_point(pch=19, size=3)+
  scale_color_manual(values = PFAA_cols)+
  # scale_fill_manual(values = PFAA_cols)+
  theme_bw()+
  # ylim(-15,15)+
  theme(legend.position = "none")+
  ylab("PFAS and species")+
  xlab("")+
  theme(axis.text.x = element_text(angle = 0))+
  ggtitle("JBA Spring (trophic diet)")+
  theme(plot.margin = unit(c(1,1,-0.5,1), "cm"))
  # scale_x_discrete(labels = c("JBA \n spring", "JBA \n summer", "Willow \nGrove"))

p_error2<-ggplot(data = AllDataJBAsp_fw[!AllDataJBAsp_fw$PFAA == "PFOS", ],
           aes(color = PFAA, 
               x = c(10^Obs_logngkg - 10^log_ngkg_re)/1000,
               y = reorder(spp_pfaa, c(10^Obs_logngkg - 10^log_ngkg_re)/1000),
               group = interaction(SppAlias, PFAA),
               size = `Diet_up%`))+
  geom_point(pch=19, size=3)+
  scale_color_manual(values = PFAA_cols)+
  # scale_fill_manual(values = PFAA_cols)+
  theme_bw()+
  # ylim(-15,15)+
  theme(legend.position = "none")+
  ylab("PFAS and species")+
  xlab("The difference between observed and measured PFAS (ng/g)")+
  theme(axis.text.x = element_text(angle = 0))+
  ggtitle("")+
  theme(plot.margin = unit(c(-0.5,1,1,1), "cm"))

cowplot::plot_grid(p_error, p_error2,
                   rel_heights = c(0.4, 1), 
                   nrow = 2, ncol =1)


# JBA summer 
AllDataJBAsum_fw$sump_pfaa<-paste(AllDataJBAsum_fw$PFAA,
                                AllDataJBAsum_fw$SppAlias)

p_error<-ggplot(data = AllDataJBAsum_fw[AllDataJBAsum_fw$PFAA == "PFOS", ],
           aes(color = PFAA, 
               x = c(10^Obs_logngkg - 10^log_ngkg_re)/1000,
               y = reorder(sump_pfaa, c(10^Obs_logngkg - 10^log_ngkg_re)/1000),
               group = interaction(SppAlias, PFAA),
               size = `Diet_up%`))+
  geom_point(pch=19, size=3)+
  scale_color_manual(values = PFAA_cols)+
  # scale_fill_manual(values = PFAA_cols)+
  theme_bw()+
  # ylim(-15,15)+
  theme(legend.position = "none")+
  ylab("PFAS and sumecies")+
  xlab("")+
  theme(axis.text.x = element_text(angle = 0))+
  ggtitle("JBA Summer (trophic diet)")+
  theme(plot.margin = unit(c(1,1,-0.5,1), "cm"))
  # scale_x_discrete(labels = c("JBA \n sumring", "JBA \n summer", "Willow \nGrove"))

p_error2<-ggplot(data = AllDataJBAsum_fw[!AllDataJBAsum_fw$PFAA == "PFOS", ],
           aes(color = PFAA, 
               x = c(10^Obs_logngkg - 10^log_ngkg_re)/1000,
               y = reorder(sump_pfaa, c(10^Obs_logngkg - 10^log_ngkg_re)/1000),
               group = interaction(SppAlias, PFAA),
               size = `Diet_up%`))+
  geom_point(pch=19, size=3)+
  scale_color_manual(values = PFAA_cols)+
  # scale_fill_manual(values = PFAA_cols)+
  theme_bw()+
  # ylim(-15,15)+
  theme(legend.position = "none")+
  ylab("PFAS and sumecies")+
  xlab("The difference between observed and measured PFAS (ng/g)")+
  theme(axis.text.x = element_text(angle = 0))+
  ggtitle("")+
  theme(plot.margin = unit(c(-0.5,1,1,1), "cm"))

cowplot::plot_grid(p_error, p_error2,
                   rel_heights = c(0.4, 1), 
                   nrow = 2, ncol =1)


# Willow Grove
AllDataWG_fw$sump_pfaa<-paste(AllDataWG_fw$PFAA,
                                AllDataWG_fw$SppAlias)

p_error<-ggplot(data = AllDataWG_fw[AllDataWG_fw$PFAA == "PFOS", ],
           aes(color = PFAA, 
               x = c(10^Obs_logngkg - 10^log_ngkg_re)/1000,
               y = reorder(sump_pfaa, c(10^Obs_logngkg - 10^log_ngkg_re)/1000),
               group = interaction(SppAlias, PFAA),
               size = `Diet_up%`))+
  geom_point(pch=19, size=3)+
  scale_color_manual(values = PFAA_cols)+
  # scale_fill_manual(values = PFAA_cols)+
  theme_bw()+
  # ylim(-15,15)+
  theme(legend.position = "none")+
  ylab("PFAS and sumecies")+
  xlab("")+
  theme(axis.text.x = element_text(angle = 0))+
  ggtitle("Willow Grove (trophic diet)")+
  theme(plot.margin = unit(c(1,1,-0.5,1), "cm"))
  # scale_x_discrete(labels = c("JBA \n sumring", "JBA \n summer", "Willow \nGrove"))

p_error2<-ggplot(data = AllDataWG_fw[!AllDataWG_fw$PFAA == "PFOS", ],
           aes(color = PFAA, 
               x = c(10^Obs_logngkg - 10^log_ngkg_re)/1000,
               y = reorder(sump_pfaa, c(10^Obs_logngkg - 10^log_ngkg_re)/1000),
               group = interaction(SppAlias, PFAA),
               size = `Diet_up%`))+
  geom_point(pch=19, size=3)+
  scale_color_manual(values = PFAA_cols)+
  # scale_fill_manual(values = PFAA_cols)+
  theme_bw()+
  # ylim(-15,15)+
  theme(legend.position = "none")+
  ylab("PFAS and sumecies")+
  xlab("The difference between observed and measured PFAS (ng/g)")+
  theme(axis.text.x = element_text(angle = 0))+
  ggtitle("")+
  theme(plot.margin = unit(c(-0.5,1,1,1), "cm"))

cowplot::plot_grid(p_error, p_error2,
                   rel_heights = c(0.4, 1), 
                   nrow = 2, ncol =1)

# ggformat(p_mb1, y_title = "Model Bias (tissue conc.)", x_title = "", size_text = 12, print = T)
# p_mb1<- p_mb1 +
#   theme(
#     panel.background = element_rect(fill='transparent'), #transparent panel bg
#     plot.background = element_rect(fill='transparent', color=NA), #transparent plot bg
#     panel.grid.major = element_blank(), #remove major gridlines
#     panel.grid.minor = element_blank(), #remove minor gridlines
#     legend.background = element_rect(fill='transparent'), #transparent legend bg
#     legend.box.background = element_rect(fill='transparent') #transparent legend panel
#   )
# p_mb1

# 
# ggsave(filename = "../../Figures/fig2_mb_oct31.png", plot = p_mb1, height = 3.5, width = 6, bg = "transparent")


```

```{r data table error by syst, fig.cap="Average model bias"}

err_data %>%
  pivot_wider(names_from = model, values_from = MB) %>% 
  kbl(digits = 3) %>%
  kable_classic(full_width = F, html_font = "Verdana")

```

Model bias in each system by PFAS. 
The perfect fit is at MB = 1. When values reach 2 and 0.5, they are systematically over-predicted or under-predicted by a factor of two, respectively. 


```{r model bias plots 2, fig.cap= "Figure 6.", include = FALSE, eval = FALSE}
cv_data<-rbind(d_cv, d_cv_fw)

p_mb2<-ggplot(data = rbind(d_cv, d_cv_fw),
           aes(
               x = System, y = MB,
               shape = model, 
               group = interaction(model)))+
  geom_point(position = position_dodge(width = 0.5),
           stat = "identity", size=3)+
  scale_shape_manual(values = c(21,19))+
  # geom_hline(yintercept = 1, color = "black")+
  # geom_hline(yintercept = c(0.5, 2), color = "black", linetype = 2, linewidth = 0.1)+
  scale_color_manual(values = PFAA_cols)+
  # scale_fill_manual(values = PFAA_cols)+
  theme_bw()+
  ylim(0,1.2)+
  theme(legend.position = "top")+
  ylab("Model Bias CV (tissue conc.)")+
  theme(axis.text.x = element_text(angle = 0))+
  # coord_flip()+
  scale_x_discrete(labels = c("JBA \n spring", "JBA \n summer", "Willow \nGrove"))
p_mb2

```


```{r data table error by spp, fig.cap="Model bias coeficient of variation"}

cv_data%>%
  pivot_wider(names_from = model, values_from = MB) %>% 
  kbl(digits = 3) %>%
  kable_classic(full_width = F, html_font = "Verdana")

```

Model bias in each system by species. 
The perfect fit is at MB = 1. When values reach 2 and 0.5, they are systematically over-predicted or under-predicted by a factor of two, respectively. 

<br/> <br/>
 
#### Sample size of observed values and species specific error

```{r sample size of observations and error}

n_fish$System <- paste(n_fish$loc, "-", tolower(n_fish$Seasonality), sep = "") # from Monte Carlo data wrangling or setup file
n_fish[n_fish$System == "WG-fall", "System"] <- "Willow Grove"
d<-merge(d, n_fish ,by = c("System", "SppAlias"), all.x = TRUE)

ggplot(d, aes(x = n, y = log_ngkg_re - Obs_logngkg,
              fill = System, group = System))+
  facet_grid(.~PFAA)+
  scale_fill_grey()+
  geom_smooth(method = "lm", aes(group = NULL, fill = NULL), color = "black")+
  geom_point(color = "black", pch=21)+
  theme_bw()+
  ylab("Diff bioconc (log(Pred) - log(Obs))")+
  xlab("The number of samples collected")
  


```

<br/> <br/>

#### Contributions to PFAA bioaccumulation via diet and water

```{r setup dataframes add trophic levels}

# JBA summer
jba_sum_trophic_levels<-data.frame(
  SppAlias = c("Phy", "Dac", "Dar", "Min", "Fal", "Bas", "Mad", "Pum", "Swa"), 
  trophic = c(0,       2.62, 3.75,  2.92,  3.25,  1.5,   3.53,  3.83,  2.5),
  System = c("JBA-summer"),
  loc = "JBA sum")

jba_sp_trophic_levels<-data.frame(
  SppAlias = c("Phy", "Kil", "Chu", "Dac", "Dar", "Min", "Mad", "Pum", "Swa"), 
  trophic = c(0,       2.5,  3.93,   2.62,  3.75,  2.92,  3.53,  3.83,  2.5),
  System = c("JBA-spring"),
  loc = "JBA sp")

wg_trophic_levels<-data.frame(
  SppAlias = c("Phy", "Pry", "Bgl", "Bas"), 
  trophic = c(0,        2.31, 3.08,  3.69),
  System = c("Willow Grove"), 
  loc = "WG")

d_sed<-merge(d,
      rbind(jba_sum_trophic_levels, jba_sp_trophic_levels, wg_trophic_levels),
      by = c("SppAlias", "System"))

AllDataWG$loc<-"WG"
AllDataJBAsp$loc<-"JBA sp"
AllDataJBAsum$loc<-"JBA sum"
AllData<-rbind(AllDataWG, AllDataJBAsp, AllDataJBAsum) # only 
AllData <- AllData[!c(AllData$PFAA == "PFUA" ),]

AllData<-merge(AllData,
      rbind(jba_sum_trophic_levels, jba_sp_trophic_levels, wg_trophic_levels),
      by = c("SppAlias", "loc", "System"))
      

# stackbar dataset
AllData_m<-melt(AllData[, c("SppAlias", "PFAA", "Gill_up%", "Diet_up%", "Sed_up%",
                            "WB", "C_WTO", "C_s", "loc")],
                id.vars=c("loc","SppAlias", "PFAA", "WB", "C_WTO", "C_s"))

# summarize means for % uptake for each run
mean_d_pct<-AllData_m %>%
dplyr::group_by(PFAA, SppAlias, variable, C_WTO, C_s, WB, loc) %>%
summarize(mean_pct = mean(value),
          sd_pct = sd(value)) 

mean_d_pct_m<-mean_d_pct %>% 
  dplyr::group_by(PFAA, variable, C_WTO, C_s) %>%
  summarize(mean_pct = mean(mean_pct),
          sd_pct = sd(mean_pct)) 
  
# summarize actual values 
mean_d<-AllData %>%
dplyr::group_by(PFAA, SppAlias, loc) %>%
summarize(Gill = mean(`Gill_uptake`),
          Diet = mean(`Dietary_uptake`),
          Sediment = mean(`Sediment_uptake`),
          Elimination = mean(`Total Elimination`), 
          WB = mean(WB)) %>%
pivot_longer(cols = c(Gill, Diet, Sediment, Elimination), names_to = "Path", values_to = "Uptake_g.kg.day")

mean_sd<-AllData %>%
dplyr::group_by(PFAA, SppAlias, loc) %>%
summarize(Gill = sd(`Gill_uptake`),
          Diet = sd(`Dietary_uptake`),
          Sediment = sd(`Sediment_uptake`),
          Elimination = sd(`Total Elimination`),
          WB = mean(WB)) %>%
pivot_longer(cols = c(Gill, Diet, Sediment, Elimination), names_to = "Path", values_to = "Uptake_SD_g.kg.day")

AllData_m2 <- merge(mean_d, mean_sd, all.x = TRUE, by = c("PFAA", "SppAlias", "Path", "loc", "WB"))

# water to sediment PFAS ratio
AllData$sed_wt_pfas_ratio <- AllData$C_s/AllData$C_WTO

# labels chemID
PFAA_List <- data.frame(PFAA = c('PFHxS','PFOS','PFOA','PFNA','PFDA','PFUA'), PFAA_labels = c('C6 PFSA','C8 PFSA','C8 PFCA', 'C9 PFCA','C10 PFCA','C11 PFCA'), PFAA_n = c(6,8,8,9,10,11))
AllData<-merge(AllData, PFAA_List, by = "PFAA")

AllData$PFAA_labels<-factor(AllData$PFAA_labels)
AllData$PFAA_labels<-factor(AllData$PFAA_labels, levels = c('C6 PFSA','C8 PFSA','C8 PFCA', 'C9 PFCA','C10 PFCA'))
```


 <br/>

```{r water vs gill figure, echo = FALSE, message = FALSE, warning  = FALSE, fig.height = 10, fig.width = 10, fig.align = "center", eval = TRUE, fig.cap= "Figure 7. Dietary uptake with mean diet intake"}
ggplot(mean_d_pct[!mean_d_pct$SppAlias == "Phy", ],
       aes( x=mean_pct*100, y=SppAlias, color = variable, fill = variable)) + 
    geom_bar(stat="identity", position = "stack") +
    # geom_errorbarh(data = mean_d_pct[mean_d_pct$variable == "Diet_up%" & !mean_d_pct$SppAlias == "Phy", ],
    #                 aes(xmin=mean_pct*100-sd_pct*100, xmax=mean_pct*100+sd_pct*100), 
    #                 position = "dodge", size = 0.5, height = 0.3, color = "black")+
    facet_wrap(loc~PFAA, scales = "free")+
    scale_fill_manual(breaks = c("Diet_up%", "Gill_up%", "Sed_up%"), values = c("#007445", "#00C6FF", "#915801"),
                      labels=c("Diet uptake","Gill uptake", "Sediment uptake"))+
    scale_color_manual(breaks = c("Diet_up%", "Gill_up%", "Sed_up%"), values = c("#007445", "#00C2FF", "#915801"),
                      labels=c("Diet uptake","Gill uptake", "Sediment uptake"))+  ylab("Species")+
  xlab("% Uptake")+
  # coord_polar()+
  theme_bw()+
  theme(legend.position = "top")
```
 

The predicted % contribution from gill uptake and dietary uptake in total PFAS uptake in each fish species in each system. 
JBA = Joint Base Andrews. WG = Willow Grove. Species Abbreviations: 
 
 <br/>
 
```{r diet to water uptake, fig.width=5, fig.height=10, eval = FALSE}

p_diet_water<-ggplot(mean_d_pct[!mean_d_pct$SppAlias == "Phy" & mean_d_pct$loc == "JBA sum", ],
       aes( x=mean_pct*100, y=SppAlias,
            color = variable,
            fill = variable,
            group = loc)) + 
    geom_bar(stat="identity", position = "stack",
             color = "black",
             stroke = 0.3)+
    facet_wrap(.~PFAA, scales = "free", nrow =5)+
    scale_fill_manual(breaks = c("Diet_up%", "Gill_up%", "Sed_up%"), values = c("#007445", "#00C2FF", "#915801"),
                      labels=c("Diet uptake","Gill uptake", "Sediment uptake"))+
  scale_y_discrete(breaks = c("Swa",
                              "Pum",
                              "Min",
                              "Mad",
                              "Fal",
                              "Dar",
                              "Dac",
                              "Bas"), 
                   labels = c("Swallowtail Shiner",
                              "Pumkinseed",
                              "Mudminnow",
                              "Margined Madtom",
                              "Fallfish",
                              "Darter sp.",
                              "Dace sp.",
                              "Largemouth Bass"))+
  ylab("Species")+
  xlab("% Uptake")+
  theme_bw()+
  theme(legend.position = "right")

ggformat(p_diet_water, y_title = 'Species', x_title = "% Uptake", title = "JBA summer", size_text = 12)
p_diet_water<-p_diet_water+ theme(legend.position = "right")
# ggsave(filename = "../Figures/fig8_deit_water_now1.png", plot = p_diet_water, height = 10, width = 5)


```

```{r uptake and depuration rates per day, echo = FALSE, message = FALSE, warning  = FALSE, fig.width=10, fig.height=7,  fig.align = "center", eval = FALSE, fig.cap= "Figure 8."}
ggplot(AllData_m2[!AllData_m2$SppAlias == "Phy", ],
      aes(fill = Path, x = Uptake_g.kg.day, y = SppAlias, color = Path)) + 
    geom_bar(stat="identity", position = "dodge", color = "white") +
    # geom_pointrange(aes(y = SppAlias,
    #                xmin=`Uptake_%g.kg.day`-`Uptake_SD_%g.kg.day`,
    #                xmax=`Uptake_%g.kg.day`+`Uptake_SD_%g.kg.day`), position = position_dodge(width = 1))+
    facet_wrap(.~PFAA, scales = "free")+
    scale_fill_manual(breaks = c("Diet", "Gill", "Sediment", "Elimination"),
                      values = c("#007445", "#00C2FF", "#915801", "black"),
                      labels=c("Diet uptake","Gill uptake", "Sediment", "Total Elimination"))+
  ylab("Species")+
  xlab("Uptake h/kg/d")+
  theme_bw()+
  theme(legend.position = "top",
        legend.title = element_blank(),
        legend.text=element_text(size=15))


```

The modeled uptake rates and elimination of PFAS by each species. 

<br/>


```{r Diet and total tissue PFAA}

pdiet_water2<-ggplot(data = AllData[c(!AllData$SppAlias =="Phy" ),],
       aes(x = `Diet_up%`, 
           y = log_ngkg_re, 
           color = PFAA,
           shape = loc,
           group  = interaction(PFAA)))+
  geom_point(size = 3)+
  scale_color_manual(values = PFAA_cols)

ggformat(pdiet_water2, x_title = ("Dietary uptake (% total)"), y_title = ("Modeled log PFAS (ng/kg); known diet"), size_text = 12, print = T)


```

##### **Figure 9.** 
The % uptake that come from diet is positively correlated with total PFAS tissue bioaccumulation. 
Each dot is a species. 

<br/>

```{r trophic level and the effect on the diet, fig.height = 6, fig.width = 8, fig.align = "center", eval = TRUE}
ggplot(AllData[!AllData$SppAlias == "Phy",], aes(y=`Diet_up%`*100,
                    x = trophic, color = PFAA))+
  geom_point(size = 2)+
  facet_grid(.~loc, scales = "free")+
  scale_color_manual(values = PFAA_cols)+
  # ylim(0,100)+
  geom_smooth(method = "lm", se = F, linewidth = 1.5, alpha = 0.5)+
  theme_bw()+
  xlab("Trophic level")+
  ylab("PFAA dietary uptake (%)")
# ggsave(filename = "./Figures/poster_sediment_PFOS_bioaccum_JBAsummer.png", width = 5, height = 5)
```

##### **Figure 10.** 
Dietary PFAS uptake (%) is higher in fish at higher trophic levels.  

<br/>


 
```{r Sed_trophic and error rates}
ggplot(AllData[!AllData$SppAlias == "Phy",],
       aes(y=`Diet_up%`*100,
           x = PFAA_labels,
           group = SppAlias,
           color = PFAA))+
  geom_point(size = 1)+
  facet_wrap(.~loc)+
  scale_color_manual(values = PFAA_cols)+
  # geom_line(linewidth = 0.5)+
  ylim(0,100)+
  theme_bw()+
  xlab("PFAA chain length")+
  ylab("PFAA dietary uptake (%)")+
  theme(axis.text.x = element_text(angle = 45))

```


##### **Figure 11** 
The chain length of perfluoroalkyl carboxylic acids (PFCA) and perfluorosulfonic acids (PFSA) and the % diet contribution in total PFAS uptake.
Each dot is species; all systems are presented together. 

<br/>

```{r Sed_trophic and error rates2}
ggplot(AllData,
       aes(y= log_ngkg_re,
           x = PFAA_labels,
           group = SppAlias, 
           color = PFAA))+
  geom_point(size = 1)+
  geom_point(size = 1, pch=21, position = position_nudge(x = 0.1),
             mapping = aes(y= Obs_logngkg,
                           x = PFAA_labels,
                           group = SppAlias, 
                           color = PFAA))+
  scale_color_manual(values = PFAA_cols)+
  # geom_line(linewidth = 0.5)+
  theme_bw()+
  xlab("PFAA chain length")+
  ylab("Tissue PFAA bioconcentriotions log(ng/kg)")+
  theme(axis.text.x = element_text(angle = 45))

```

##### **Figure 12**
The chain length of perfluoroalkyl carboxylic acids (PFCA) and perfluorosulfonic acids (PFSA) and their tissue bioaccumulation. 
Each dot is species; all systems are presented together. The open circles are observed values, the closed circles are modeled values. 

<br/>


```{r sediment to water ratio}
# p_sed1<-ggplot(AllData[!c(AllData$SppAlias == "Phy"),],
#        aes(y=log_ngkg_re, x = sed_wt_pfas_ratio,
#            group = interaction( PFAA),
#            color = PFAA, size = C_s))+
#   geom_smooth(method = "lm", se = F)+
#   # geom_point( pch=21)+
#   # facet_grid(.~PFAA, scales = "free")+
#   scale_color_manual(values = PFAA_cols)+
#   scale_linetype_manual(values = c("dashed", "dotted", "solid"))+
#   theme_bw()
# ggformat(p_sed1, x_title = ("PFAA sediment:water ratio"),
#          y_title = ("Tissue PFAA (ng/kg)"))


##### **Figure 13** 
# Predicted relationship between sediment:water PFAS ratio and fish tissue bioconcentrations. 
# The higher ratios are when water is dominant in source of system PFAS. The total PFAS bioaccumulation in fish increases when. Each dot is a species. The size is proportional to sediment PFAS concentrations (ng/g).

```


<br/>

```{r sediment to water ratio2}

means_d<-AllData[!c(AllData$SppAlias == "Phy"),] %>% 
  dplyr:::group_by(loc, PFAA) %>% 
  summarize(mean_pfos = mean(`Diet_up%`), 
            mean_ratio = mean(sed_wt_pfas_ratio), 
            C_s = mean(C_s))
  

p_sed1<-ggplot(AllData[!c(AllData$SppAlias == "Phy"),],
       aes(y= `Diet_up%`, x = sed_wt_pfas_ratio,
           group = interaction( PFAA),
           color = PFAA,
           size = C_s))+
  # geom_point(data = means_d, aes(x = mean_ratio, y = mean_pfos, 
                                 # size = NULL), size = 4)+
  # geom_line(data = means_d, aes(x = mean_ratio, y = mean_pfos, 
                                # size = NULL), linewidth = 0.5)+
  # geom_smooth(method = "lm", formula = y~poly(x,1), se = F)+
  geom_point( pch=21)+
  # facet_grid(.~PFAA, scales = "free")+
  scale_color_manual(values = PFAA_cols)+
  scale_linetype_manual(values = c("dashed", "dotted", "solid"))+
  theme_bw()
ggformat(p_sed1, x_title = ("PFAA sediment:water ratio"),
         y_title = ("% Diet uptake"), print = T)


```

##### **Figure 14**
Predicted positive relationship between sediment:water PFAS ratio and fish tissue bioconcentrations. 
The higher the ratio the more sediment (ng/g) PFAS in relation to water PFAS (ml/L) the higher total PFAS bioaccumulation in fish. Each dot is a species.




<!-- #### Sediment:Water ratio data: visualize -->

```{r loop sediment ratios source data, message = FALSE, eval=F, warning  = FALSE,  fig.width=10, fig.height=7,  fig.align = "center"}

# the data are read in and saved above when sourcing tables for each system
# create an identical data frame that will be filled in with values 
# based on the selected sed:water ratio
sed_WG<-water_WG[-1,] 
sed_JBAsp<-water_JBAsp[-1,]       
sed_JBAsum<-water_JBAsum[-1,]  

settings_modelDiet = new_Settings(
  chooseDiet = 'default'
)

# sediment water ratios that are empirically observed
l<-2
# r_PFAAs <- c(seq(0.01,0.1, length.out = l/2), seq(1, 5, length.out = l/2))
r_PFAAs<-c(seq(0.001,5, length.out = 0.5*l), seq(7, 30, length.out = 0.5*l))
# custom length out, for 30 low range, 30 high range. 

for(i in 1:l){
  # loop through all ratios 
  
  sed_WG[1,"PFHxS"] <- (water_WG[1, "PFHxS"]) * r_PFAAs[i]  # water in ng/ml, sed in ng/g
  sed_WG[1,"PFOS"] <- (water_WG[1, "PFOS"]) * r_PFAAs[i] 
  sed_WG[1,"PFOA"] <- (water_WG[1, "PFOA"]) * r_PFAAs[i] 
  sed_WG[1,"PFNA"] <- (water_WG[1, "PFNA"]) * r_PFAAs[i] 

  sed_JBAsp[1,"PFHxS"]<-(water_JBAsp[1, "PFHxS"]) * r_PFAAs[i] 
  sed_JBAsp[1,"PFOS"]<-(water_JBAsp[1, "PFOS"]) * r_PFAAs[i]
  sed_JBAsp[1,"PFOA"]<-(water_JBAsp[1, "PFOA"]) * r_PFAAs[i]
  sed_JBAsp[1,"PFNA"]<-(water_JBAsp[1, "PFNA"]) * r_PFAAs[i] 

  sed_JBAsum[1,"PFHxS"]<-(water_JBAsum[1, "PFHxS"]) * r_PFAAs[i] 
  sed_JBAsum[1,"PFOS"]<-(water_JBAsum[1, "PFOS"]) * r_PFAAs[i]
  sed_JBAsum[1,"PFOA"]<-(water_JBAsum[1, "PFOA"]) * r_PFAAs[i] 
  sed_JBAsum[1,"PFNA"]<-(water_JBAsum[1, "PFNA"]) * r_PFAAs[i] 

  WG_inputFiles_list$chemicalData["C_s", 1:4]<- sed_WG[1, c("PFHxS", "PFOS", "PFOA", "PFNA")]
  WG_inputFiles_list$chemicalData["C_WTO",1:4]<-water_WG [1, c("PFHxS", "PFOS", "PFOA", "PFNA")]
  JBAsp_inputFiles_list$chemicalData["C_s", 1:4]<- sed_WG[1, c("PFHxS", "PFOS", "PFOA", "PFNA")]
  JBAsp_inputFiles_list$chemicalData["C_WTO", 1:4]<-water_WG [1, c("PFHxS", "PFOS", "PFOA", "PFNA")]
  JBAsum_inputFiles_list$chemicalData["C_s", 1:4]<- sed_WG[1, c("PFHxS", "PFOS", "PFOA", "PFNA")]
  JBAsum_inputFiles_list$chemicalData["C_WTO", 1:4]<-water_WG [1, c("PFHxS", "PFOS", "PFOA", "PFNA")]
  
  # WG 
  AllData_wg0<-runEcosystemModel(settings = settings_modelDiet,
                  inputFiles_list = WG_inputFiles_list,
                  parameterList = c('C_B','C_WTO','C_s','k1','k2','ke','kg','kd',
                                    'Total Elimination', 'RMR', "Gill_uptake",
                                    "Dietary_uptake", "Gill_up%", "Diet_up%",
                                    "Total Elimination", "G_V", "G_D"),
                  PFAA_List = c('PFHxS','PFOS','PFOA','PFNA'),
                  dietData = WG_inputFiles_list$dietData,
                  kRTable = kRTable,
                  min_diet_WTO_C_s = TRUE,
                  min_dietData = WG_inputFiles_list$min_dietData,
                  max_diet_WTO_C_s = TRUE, 
                  max_dietData = WG_inputFiles_list$max_dietData)


  # JBA spring
  AllData_jba_sp0<-runEcosystemModel(settings = settings_modelDiet,
                  inputFiles_list = JBAsp_inputFiles_list,
                  parameterList = c('C_B','C_WTO','C_s','k1','k2','ke','kg','kd',
                                    'Total Elimination', 'RMR', "Gill_uptake",
                                    "Dietary_uptake", "Gill_up%", "Diet_up%",
                                    "Total Elimination", "G_V", "G_D"),
                  PFAA_List = c('PFHxS','PFOS','PFOA','PFNA'),
                  dietData = JBAsp_inputFiles_list$dietData,
                  kRTable = kRTable,
                  min_diet_WTO_C_s = TRUE,
                  min_dietData = JBAsp_inputFiles_list$min_dietData,
                  max_diet_WTO_C_s = TRUE, 
                  max_dietData = JBAsp_inputFiles_list$max_dietData)

  # JBA summer 
  AllData_jba_sum0<-runEcosystemModel(settings = settings_modelDiet,
                  inputFiles_list = JBAsum_inputFiles_list,
                  parameterList = c('C_B','C_WTO','C_s','k1','k2','ke','kg','kd',
                                    'Total Elimination', 'RMR', "Gill_uptake",
                                    "Dietary_uptake", "Gill_up%", "Diet_up%",
                                    "Total Elimination", "G_V", "G_D"),
                  PFAA_List = c('PFHxS','PFOS','PFOA','PFNA'),
                  dietData = JBAsum_inputFiles_list$dietData,
                  kRTable = kRTable,
                  min_diet_WTO_C_s = TRUE,
                  min_dietData = JBAsum_inputFiles_list$min_dietData,
                  max_diet_WTO_C_s = TRUE, 
                  max_dietData = JBAsum_inputFiles_list$max_dietData)

  AllData_wg0$loc<-"WG"
  AllData_jba_sp0$loc<-"JBA sp"
  AllData_jba_sum0$loc<-"JBA sum"
  AllData_wg0$ratio<- r_PFAAs[i]
  AllData_jba_sp0$ratio<- r_PFAAs[i]
  AllData_jba_sum0$ratio<- r_PFAAs[i]
  AllData0<-rbind(AllData_wg0, AllData_jba_sum0, AllData_jba_sp0)
  AllData0$sed_wt_pfas_ratio<-AllData0$C_s/AllData0$C_WTO
  all(AllData0$sed_wt_pfas_ratio == AllData_jba_sp0$ratio)
  
  if(i == 1 ){
    AllData<-AllData0
  }else{
    AllData<-rbind(AllData, AllData0)
  }
  
}

AllData_sed<-AllData
```

```{r sequence sediment plots ,message = FALSE, eval = F,  warning  = FALSE,  fig.height = 3, fig.width = 10, fig.align = "center"}
p_sed1<-ggplot(AllData_sed[!c(AllData_sed$SppAlias == "Phy"),],
       aes(y=`Diet_up%`*100, x = C_s,
           group = interaction(loc, SppAlias, PFAA),
           color = PFAA))+
  # geom_point(size = 0.5)+
  facet_grid(.~PFAA, scales = "free")+
  scale_color_manual(values = PFAA_cols)+
  scale_linetype_manual(values = c("dashed", "dotted", "solid"))+
  ylim(0,100)+
  geom_line(size= 0.5)+
  theme_bw()+
  xlab("PFAA in sediment (ng/g)")+
  ylab("PFAA dietary uptake (%)")
p_sed1

# ##### **Figure 15** 
# Predicted positive relationship between sediment:water PFAS ratio and fish tissue bioconcentrations. The higher ratios are when sediment is dominant in source of system PFAS. Each dot/line is a species. 

```

```{r  sediment plots2 ,message = FALSE, warning  = FALSE, eval = F, fig.height = 5, fig.width = 5, fig.align = "center"}
p_sed2<-ggplot(AllData_sed[!c(AllData_sed$SppAlias == "Phy"),],
       aes(y=`Diet_up%`*100, x = C_s/C_WTO,
           group = interaction(loc, SppAlias, PFAA),
           color = PFAA))+
  geom_hline(yintercept = 0, color = "grey", linetype = "dashed")+
  scale_color_manual(values = PFAA_cols)+
  facet_wrap(loc~SppAlias)+
  # scale_linetype_manual(values = c("dashed", "dotted", "solid"))+
  # ylim(-7,100)+
  # xlim(0,1)+
  geom_line(size= 0.5, alpha = 0.5)+
  theme_bw()+
  xlab("PFAS in sediment:water ratio (ng/g: ng/mL)")+
  ylab("PFAS dietary uptake (%)")

p_sed2
# ggsave(filename = "../Figures/fig5_sedRatio_oct31.png", p_sed2, width = 6, height = 5)


##### **Figure 16** 
# Relationship between sediment:water PFAS ratio and % diet uptake. 
# The higher ratios are when sediment is dominant in source of system PFAS. Lines connect species. 

```




