---
title: "Error estimates"
subtitle: "What is good enough?"
author: "K. Kraskura"
date: "`r Sys.Date()`"
output: 
  # pdf_document:
  html_document:
    toc: true
    toc_float: true
    toc_collapsed: false
    toc_depth: 4
    theme: united
    highlight: tango
    code_folding: hide


---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

<br/>

### Objectives:

### Error anaylsis: what is good enough?

8.  To run error analysis taking a random one selection of species, water and sediment samples
6.  To run analysis assuming that each measurement can be +/- 30%

<br/>

### Preliminary results:

- **Even with the range of empirical values recorded (species mass, temperature, PFAA tissue, sediment and water concentrations), the predicted PFAA tissue bioconcentrations are predicted within a norrow range.** The model robustly predicts the PFAA biocenenctrations. 
  * Monte Carlo Method to estimate mean +/- SD in species specific PFAA bioconcentrations
  * The factors that contribute to the mismatch between measured and modeled predicted values are unknown and like mechanistic (species specific) and ecological (organic carbon content, other factors).
  
- Temperature ranged only between ~ 20.1 and 20.7. No change in results within that range. 
- Ventilation rate resembles the effect of body mass. Body mass does not affect bioaccumulation.
- Feeding rate positively affects bioaccumulation in neaerly all species. 


```{r source, warning=FALSE, message=FALSE, echo=TRUE}

library(kableExtra)
library(dplyr)
library(tidyverse)
library(broom)
library(tidyr)
library(ggplot2)
library(ggridges)
library(reshape)
library(tibble) # needed to get named list of dataframes (in data_tables.R)
library(readxl)
library(MCMCglmm)
library(ggsci)
library(ggalt)
library(tictoc)


# functions to run food web model
source("../R model/PFAS_bioaccum_v2.R") 
source("../R model/PFAS_classes_v2.R")
source("../R model/PFAS_steadyState_v2.R")
source("../R model/runEcosystemModels.R") # custom written
source("../R model/runErrorEstimates.R")
source("../R model/data_tables.R")
source("../R model/data_MonteCarlo.R")
source("../R model/fnx_MonteCarlo.R")

# source data tables for each objective
kRTable = read.csv('../../Data/export_krTable.csv', row.names = "X", header = T)
colnames(kRTable)<-c("kr/kb", "PFAA", "chemID")
PFAS_List <- c('PFHxS','PFOS','PFOA','PFNA','PFDA','PFUA')
PFAS_labels <- c('C6 PFSA','C8 PFSA','C8 PFCA', 'C9 PFCA','C10 PFCA','C11 PFCA')
PFAA_cols <- c('PFHxS' = '#332288', # 
             'PFOS' = '#882255', # 
             'PFOA' = '#117733',
             'PFNA' = '#88CCEE',
             'PFDA' = 'orange',
             'PFUA' = '#AA4499')

p_lines <- data.frame('x' = c(0, 7),
                      'y' = c(0, 7))
p_lines$y1 <- p_lines$x-1
p_lines$y2 <- p_lines$x+1
p_lines$y3 <- p_lines$x-log10(2)
p_lines$y4 <- p_lines$x+log10(2)

```

```{r mcmc run modeled, eval=FALSE, message = TRUE}
settings_obsDiet = new_Settings(
  chooseDiet = 'forced',
)

settings_modelDiet = new_Settings(
  chooseDiet = 'default',
)


tic("Observed PFAA in Diet: random sampling MCMC models for all systems")
A.jba.sum<-mcmc_input_files(location = "JBA",
                    season = "Summer", 
                    species_list = c("Dac",	"Dar",	"Min",	"Fal",	"Bas",	"Mad",	"Pum",	"Swa"),
                    PFAAs = c("PFHxS", "PFOS", "PFOA", "PFNA", "PFDA", "PFUA"),
                    n_iter = 100,
                    settings_obsDiet = settings_obsDiet,
                    settings_modelDiet = settings_modelDiet, 
                    modeledDiet = TRUE)

A.jba.sp<-mcmc_input_files(location = "JBA",
                    season = "Spring", 
                    species_list = c("Kil"	,"Chu",	"Dac", "Dar",	"Min",	"Mad",	"Pum",	"Swa"),
                    PFAAs = c("PFHxS", "PFOS", "PFOA", "PFNA", "PFDA", "PFUA"),
                    n_iter = 100,
                    settings_obsDiet = settings_obsDiet,
                    settings_modelDiet = settings_modelDiet,
                    modeledDiet = TRUE)

A.wg<-mcmc_input_files(location = "WG",
                    season = "Fall", 
                    species_list = c("Pry", "Bgl", "Bas"),
                    PFAAs = c("PFHxS", "PFOS", "PFOA", "PFNA", "PFDA", "PFUA"),
                    n_iter = 100,
                    settings_obsDiet = settings_obsDiet,
                    settings_modelDiet = settings_modelDiet,
                    modeledDiet = TRUE)

toc()

A.jba.sp$loc<-"JBA"
A.jba.sum$loc<-"JBA"
A.wg$loc<-"WG"
A.jba.sum$Seasonality<-"Summer"
A.jba.sp$Seasonality<-"Spring"
A.wg$Seasonality<-"Fall"
A<-rbind(A.jba.sp, A.jba.sum, A.wg)
write.csv(A, paste("../../Data/outputs/mcmc_replicate_runs_modeledDiet", Sys.Date(), ".csv"))

```

```{r mcmc run observed , eval=FALSE, message = FALSE}
settings_obsDiet = new_Settings(
  chooseDiet = 'forced',
)

settings_modelDiet = new_Settings(
  chooseDiet = 'default',
)

tic("Modeled PFAA in Diet: random sampling MCMC models for all systems")
A.jba.sumO<-mcmc_input_files(location = "JBA",
                    season = "Summer", 
                    species_list = c("Dac",	"Dar",	"Min",	"Fal",	"Bas",	"Mad",	"Pum",	"Swa"),
                    PFAAs = c("PFHxS", "PFOS", "PFOA", "PFNA", "PFDA", "PFUA"),
                    n_iter = 100,
                    settings_obsDiet = settings_obsDiet,
                    settings_modelDiet = settings_modelDiet, 
                    modeledDiet = FALSE,
                    observedDiet = TRUE)

A.jba.spO<-mcmc_input_files(location = "JBA",
                    season = "Spring", 
                    species_list = c("Kil"	,"Chu",	"Dac", "Dar",	"Min",	"Mad",	"Pum",	"Swa"),
                    PFAAs = c("PFHxS", "PFOS", "PFOA", "PFNA", "PFDA", "PFUA"),
                    n_iter = 100,
                    settings_obsDiet = settings_obsDiet,
                    settings_modelDiet = settings_modelDiet,
                    modeledDiet = FALSE,
                    observedDiet = TRUE)

A.wgO<-mcmc_input_files(location = "WG",
                    season = "Fall", 
                    species_list = c("Pry", "Bgl", "Bas"),
                    PFAAs = c("PFHxS", "PFOS", "PFOA", "PFNA", "PFDA", "PFUA"),
                    n_iter = 100,
                    settings_obsDiet = settings_obsDiet,
                    settings_modelDiet = settings_modelDiet,
                    modeledDiet = FALSE,
                    observedDiet = TRUE)

toc()

A.jba.spO$loc<-"JBA"
A.jba.sumO$loc<-"JBA"
A.wgO$loc<-"WG"
A.jba.sumO$Seasonality<-"Summer"
A.jba.spO$Seasonality<-"Spring"
A.wgO$Seasonality<-"Fall"
AO<-rbind(A.jba.spO, A.jba.sumO, A.wgO)
write.csv(AO, paste("../../Data/outputs/mcmc_replicate_runs_observedDiet", Sys.Date(), ".csv"))

```

```{r read in and organisze saved data}

A<-read.csv(file = paste("../../Data/outputs/", list.files(path = "../../Data/outputs/", pattern = "modeled"),sep=""))
AO<-read.csv(file = paste("../../Data/outputs/", list.files(path = "../../Data/outputs/", pattern = "observed"),sep=""))


# set percent error: 
pct<-0.3
A$Obs_logngkg_percUP <- log10((pct * A$Obs_ngg*1000) + (A$Obs_ngg*1000))
A$Obs_logngkg_percLO <- log10((A$Obs_ngg*1000) - (pct * A$Obs_ngg*1000))
AO$Obs_logngkg_percUP <- log10((pct * AO$Obs_ngg*1000) + (AO$Obs_ngg*1000))
AO$Obs_logngkg_percLO <- log10((AO$Obs_ngg*1000) - (pct * AO$Obs_ngg*1000))


A<-A[!c(A$PFAA == "PFUA" | A$PFAA == "PFDA"),]
A$system<-paste(A$loc, A$Seasonality, sep =" ")
AO<-AO[!c(AO$PFAA == "PFUA" | AO$PFAA == "PFDA"),]
AO$system<-paste(AO$loc, AO$Seasonality, sep =" ")

AO$spp_PFAA<-paste(AO$SppAlias, AO$PFAA, sep =" ")


```

<!-- ```{r mcmc run modeled sed ratio, eval=TRUE, message = FALSE} -->
<!-- settings_obsDiet = new_Settings( -->
<!--   chooseDiet = 'forced', -->
<!-- ) -->

<!-- settings_modelDiet = new_Settings( -->
<!--   chooseDiet = 'default', -->
<!-- ) -->


<!-- tic("Observed PFAA in Diet: random sampling MCMC models for all systems") -->
<!-- A.jba.sum.s<-mcmc_input_files(location = "JBA", -->
<!--                     season = "Summer",  -->
<!--                     species_list = c("Dac",	"Dar",	"Min",	"Fal",	"Bas",	"Mad",	"Pum",	"Swa"), -->
<!--                     PFAAs = c("PFHxS", "PFOS", "PFOA", "PFNA", "PFDA", "PFUA"), -->
<!--                     n_iter = 50, -->
<!--                     settings_obsDiet = settings_obsDiet, -->
<!--                     settings_modelDiet = settings_modelDiet,  -->
<!--                     modeledDiet = TRUE, -->
<!--                     sediment_ratio_range = c(0, 1), # water: sediment -->
<!--                     sediment_ratio_only = TRUE) -->

<!-- A.jba.sp.s<-mcmc_input_files(location = "JBA", -->
<!--                     season = "Spring",  -->
<!--                     species_list = c("Kil"	,"Chu",	"Dac", "Dar",	"Min",	"Mad",	"Pum",	"Swa"), -->
<!--                     PFAAs = c("PFHxS", "PFOS", "PFOA", "PFNA", "PFDA", "PFUA"), -->
<!--                     n_iter = 50, -->
<!--                     settings_obsDiet = settings_obsDiet, -->
<!--                     settings_modelDiet = settings_modelDiet, -->
<!--                     modeledDiet = TRUE, -->
<!--                     sediment_ratio_range = c(0, 1), # water: sediment -->
<!--                     sediment_ratio_only = TRUE) -->

<!-- A.wg.s<-mcmc_input_files(location = "WG", -->
<!--                     season = "Fall",  -->
<!--                     species_list = c("Pry", "Bgl", "Bas"), -->
<!--                     PFAAs = c("PFHxS", "PFOS", "PFOA", "PFNA", "PFDA", "PFUA"), -->
<!--                     n_iter = 50, -->
<!--                     settings_obsDiet = settings_obsDiet, -->
<!--                     settings_modelDiet = settings_modelDiet, -->
<!--                     modeledDiet = TRUE, -->
<!--                     sediment_ratio_range = c(0, 1), # water: sediment -->
<!--                     sediment_ratio_only = TRUE) -->

<!-- toc() -->

<!-- A.jba.sp.s$loc<-"JBA" -->
<!-- A.jba.sum.s$loc<-"JBA" -->
<!-- A.wg.s$loc<-"WG" -->
<!-- A.jba.sum.s$Seasonality<-"Summer" -->
<!-- A.jba.sp.s$Seasonality<-"Spring" -->
<!-- A.wg.s$Seasonality<-"Fall" -->
<!-- A.s<-rbind(A.jba.sp.s, A.jba.sum.s, A.wg.s) -->
<!-- write.csv(A.s, paste("../../Data/outputs/mcmc_replicate_runs_modSEDRATIO", Sys.Date(), ".csv")) -->

<!-- ``` -->

<!-- ```{r mcmc run observed model sed ratio , eval=FALSE, message = FALSE} -->
<!-- settings_obsDiet = new_Settings( -->
<!--   chooseDiet = 'forced', -->
<!-- ) -->

<!-- settings_modelDiet = new_Settings( -->
<!--   chooseDiet = 'default', -->
<!-- ) -->

<!-- tic("Modeled PFAA in Diet: random sampling MCMC models for all systems") -->
<!-- A.jba.sumO.s<-mcmc_input_files(location = "JBA", -->
<!--                     season = "Summer", -->
<!--                     species_list = c("Dac",	"Dar",	"Min",	"Fal",	"Bas",	"Mad",	"Pum",	"Swa"), -->
<!--                     PFAAs = c("PFHxS", "PFOS", "PFOA", "PFNA", "PFDA", "PFUA"), -->
<!--                     n_iter = 30, -->
<!--                     settings_obsDiet = settings_obsDiet, -->
<!--                     settings_modelDiet = settings_modelDiet, -->
<!--                     modeledDiet = FALSE, -->
<!--                     observedDiet = TRUE, -->
<!--                     sediment_ratio_range = c(0, 1)) -->

<!-- A.jba.spO.s<-mcmc_input_files(location = "JBA", -->
<!--                     season = "Spring", -->
<!--                     species_list = c("Kil"	,"Chu",	"Dac", "Dar",	"Min",	"Mad",	"Pum",	"Swa"), -->
<!--                     PFAAs = c("PFHxS", "PFOS", "PFOA", "PFNA", "PFDA", "PFUA"), -->
<!--                     n_iter = 30, -->
<!--                     settings_obsDiet = settings_obsDiet, -->
<!--                     settings_modelDiet = settings_modelDiet, -->
<!--                     modeledDiet = FALSE, -->
<!--                     observedDiet = TRUE, -->
<!--                     sediment_ratio_range = c(0,1)) -->

<!-- A.wgO.s<-mcmc_input_files(location = "WG", -->
<!--                     season = "Fall", -->
<!--                     species_list = c("Pry", "Bgl", "Bas"), -->
<!--                     PFAAs = c("PFHxS", "PFOS", "PFOA", "PFNA", "PFDA", "PFUA"), -->
<!--                     n_iter = 30, -->
<!--                     settings_obsDiet = settings_obsDiet, -->
<!--                     settings_modelDiet = settings_modelDiet, -->
<!--                     modeledDiet = FALSE, -->
<!--                     observedDiet = TRUE, sediment_ratio_range = c(0, 1)) -->

<!-- toc() -->

<!-- A.jba.spO.s$loc<-"JBA" -->
<!-- A.jba.sumO.s$loc<-"JBA" -->
<!-- A.wgO.s$loc<-"WG" -->
<!-- A.jba.sumO.s$Seasonality<-"Summer" -->
<!-- A.jba.spO.s$Seasonality<-"Spring" -->
<!-- A.wgO.s$Seasonality<-"Fall" -->
<!-- AO.s<-rbind(A.jba.spO.s, A.jba.sumO.s, A.wgO.s) -->
<!-- write.csv(AO.s, paste("../../Data/outputs/mcmc_replicate_runs_observedDietSEDRATIO", Sys.Date(), ".csv")) -->

<!-- ``` -->


### Error estimated for modeled diet

```{r error estimate figure}
for (i in 1:length(PFAS_List)){
  
  if(PFAS_List[i] == "PFUA" | PFAS_List[i] == "PFDA"){
    next
  }
  A.0<-(A[A$PFAA == PFAS_List[i] & !c(A$SppAlias == "Phy") ,])
  
  plot <- ggplot(data = A.0, aes(x = log_ngkg_re- Obs_logngkg,
                                 y = SppAlias,
                                           group = SppAlias,
                                           fill= SppAlias))+
    geom_density_ridges(bins = 100, alpha = 0.8,
                        scale = 0.9,
                        rel_min_height = 0.01)+
    scale_fill_viridis_d()+
    facet_grid(.~system)+
    geom_vline(xintercept = 0)+
    theme_minimal()+
    guides(fill = guide_legend(nrow = 3, byrow = T)) +
    theme(legend.direction = "vertical", legend.box = "vertical")+
    theme(axis.text.x = element_text(size = 7), 
          axis.title.y = element_blank(),
          axis.title.x = element_blank())

  
  A.3 <- A.0 %>%
          group_by(SppAlias, PFAA, system) %>%
          summarise(mean_val = mean(Obs_logngkg, na.rm = TRUE),
                    mean_errUP = max(Obs_logngkg_percUP, na.rm = TRUE),
                    mean_errLO = min(Obs_logngkg_percLO, na.rm = TRUE),
                    mean_val2 = mean(log_ngkg_re, na.rm = TRUE),
                    max_val2 = max(log_ngkg_re, na.rm = TRUE),
                    min_val2 = min(log_ngkg_re, na.rm = TRUE))
  
  plot2 <-
    ggplot(data = A.0, aes(x = log_ngkg_re,
                      y = SppAlias,
                      color = PFAA, fill = PFAA))+
    # geom_density_ridges(stat = "binline", bins = 100, scale = 0.95, draw_baseline = FALSE)+
    geom_errorbarh(data = A.3[!c(A.3$SppAlias == "Phy"),],
          mapping = aes(x = mean_val, xmax = mean_errUP, xmin = mean_errLO, color = PFAA),
          height = 0.2, color = "black")+
    geom_density_ridges( draw_baseline = FALSE, alpha = 0.8,
                         scale = 0.9,
                         rel_min_height = 0.01)+
    # xlim(1, 7)+
    scale_fill_manual(name=" ", values = PFAA_cols)+
    scale_color_manual(name=" ", values = PFAA_cols)+
    theme_minimal()+
    facet_grid(.~system)+
    guides(fill = guide_legend(nrow = 2, byrow = T)) +
    theme(legend.direction = "vertical", legend.box = "vertical")+
    theme(axis.text.x = element_text(size = 7), 
          axis.title.y = element_blank(),
          axis.title.x = element_blank())
    
  
  assign(paste("p_", PFAS_List[i], sep = ""), plot)
  assign(paste("p2_", PFAS_List[i], sep = ""), plot2)
 
}

legend <- cowplot::get_legend(
  # create some space to the left of the legend
  p_PFOS + theme(legend.box.margin = margin(0, 0, 0, 12))
)
legend2 <- cowplot::get_legend(
  # create some space to the left of the legend
  p2_PFOS + theme(legend.box.margin = margin(0, 0, 0, 12))
)
# ('PFHxS','PFOS','PFOA','PFNA','PFDA','PFUA')
# PFAS_labels <- c('C6 PFSA','C8 PFSA','C8 PFCA', 'C9 PFCA','C10 PFCA','C11 PFCA')
```

```{r visualizing results plot1, fig.height = 9, fig.width=6, eval = T}
cowplot::plot_grid(p_PFHxS + theme(legend.position = "none"),
                   p_PFOS + theme(legend.position = "none"),
                   p_PFNA + theme(legend.position = "none"),
                   p_PFOA + theme(legend.position = "none"), 
                   # p_PFDA + theme(legend.position = "none"), # "PFHxS", "PFOS", "PFOA", "PFNA", "PFDA", "PFUA"
                    labels = c("PFHxS", "PFOS", "PFNA",
                                      "PFOA",  ""),
                   label_size = 10,
                   label_x = c(0.87),
                   label_y = c(0.83, 0.83, 0.83, 0.83),
                   nrow = 4, ncol = 1)
```

#### **Figure 1.** 
The difference between model estimated PFAA value and observed (empirically measured values) for each PFAA, species, and in each system. The vertical line at 0 indicates "perfect" agreement between measured and modeled values. The density plots compile model results originated from taking 1000 random draws of realistically measurable values in each system (the randomly selected values include: water, sediment, and species tissue PFAA concentrations, and water temperature; all other parameters were constant). **Only showing results for model runs where PFAA values in diet were modeled via trophic transfer**

<br/>
<br/>

```{r visualizing results plot2, fig.height = 12, fig.width=6}
cowplot::plot_grid(p2_PFHxS + theme(legend.position = "none"),
                   p2_PFOS + theme(legend.position = "none"),
                   p2_PFNA + theme(legend.position = "none"),
                   p2_PFOA + theme(legend.position = "none"), 
                   # p_PFDA + theme(legend.position = "none"), # "PFHxS", "PFOS", "PFOA", "PFNA", "PFDA", "PFUA"
                    labels = c("PFHxS", "PFOS", "PFNA",
                                      "PFOA",  ""),
                   label_size = 10,
                   label_x = c(0.87),
                   label_y = c(0.86, 0.86, 0.86, 0.86),
                   nrow = 4, ncol = 1)
```


#### **Figure 2.** 
The distributions of predicted PFAA tissue bioconcentration values, the error bar mark the range of the empirically measured value +/- 30% (the acceptable error in PFAS measurements).
The density plots compile model results originated from taking 1000 random draws of realistically measurable values in each system (the randomly selected values include: water, sediment, and species tissue PFAA concentrations, and water temperature; all other parameters were constant). **Only showing results for model runs where PFAA values in diet were modeled via trophic transfer**


<br/>
<br/>


```{r visualizing full results modeled PFAA diet, fig.height=3.5, fig.width=9.5}
# DataList$PFAA<-factor(DataList$PFAA)

ggplot(data = A, aes(x = log_ngkg_re, y = Obs_logngkg, color = PFAA))+
    geom_line(data = p_lines, mapping = aes(x = x, y = y),
              linetype = 1, linewidth = 0.5, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y1),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y2),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y3),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y4),
              linetype = 3, linewidth = 0.2, color = "black")+
    facet_grid(.~system)+
    # geom_errorbar(aes(ymin = Obs_logngkg - Obs_logngkg_Lo, ymax = Obs_logngkg + Obs_logngkg_Up), size = 0.5) +
    # geom_errorbarh(aes(xmin = log_ngkg_re - logngkg_Lo, xmax = log_ngkg_re + logngkg_Up), size = 0.5) + +
    geom_encircle(aes(fill = PFAA, color = PFAA), s_shape = 1, expand = 0,
                  alpha = 0.3,  show.legend = FALSE)+
    geom_point(pch = 19, size = 0.01)+
    theme_bw()+
    scale_color_manual(values = PFAA_cols)+
    scale_fill_manual(values = PFAA_cols)+
    ggtitle(label = 'Modeled PFAAs in diet: trophic transfer')+
    xlab('Modeled log PFAA (ng/kg)')+
    ylab('Observed log PFAA (ng/kg)')#+
    # coord_cartesian(ylim = c(2,6.5), xlim = c(2,6.5))+
    # theme(legend.position = "none")
# p1_fish


```

#### **Figure 3.** 
The results of all predicted values for each PFAA, and system. Each dot represents a species. 

```{r visualizing full results observed PFAA diet, fig.height=3.5, fig.width=9.5}
# DataList$PFAA<-factor(DataList$PFAA)

ggplot(data = AO, aes(x = log_ngkg_re, y = Obs_logngkg, color = PFAA))+
    geom_line(data = p_lines, mapping = aes(x = x, y = y),
              linetype = 1, linewidth = 0.5, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y1),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y2),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y3),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y4),
              linetype = 3, linewidth = 0.2, color = "black")+
    facet_grid(.~system)+
    # geom_errorbar(aes(ymin = Obs_logngkg - Obs_logngkg_Lo, ymax = Obs_logngkg + Obs_logngkg_Up), size = 0.5) +
    # geom_errorbarh(aes(xmin = log_ngkg_re - logngkg_Lo, xmax = log_ngkg_re + logngkg_Up), size = 0.5) + +
    geom_encircle(aes(fill = PFAA, color = PFAA), s_shape = 1, expand = 0,
                  alpha = 0.3,  show.legend = FALSE)+
    geom_point(pch = 19, size = 0.01)+
    theme_bw()+
    scale_color_manual(values = PFAA_cols)+
    scale_fill_manual(values = PFAA_cols)+
    ggtitle(label = 'Known PFAAs in diet')+
    xlab('Modeled log PFAA (ng/kg)')+
    ylab('Observed log PFAA (ng/kg)')#+
    # coord_cartesian(ylim = c(2,6.5), xlim = c(2,6.5))+
    # theme(legend.position = "none")
# p1_fish


```

#### **Figure 4.** 
The results of all predicted values for each PFAA, and system. Each dot represents a species. 

```{r species prediction, fig.height=3.5, fig.width=9.5}
ggplot(data = AO, aes(x = log_ngkg_re, y = Obs_logngkg,
                      color = spp_PFAA))+
    geom_line(data = p_lines, mapping = aes(x = x, y = y),
              linetype = 1, linewidth = 0.5, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y1),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y2),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y3),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y4),
              linetype = 3, linewidth = 0.2, color = "black")+
    facet_grid(.~system)+
    # geom_point(pch = 19, size = 0.01)+
    theme_bw()+
    geom_encircle(aes(fill = spp_PFAA, color = spp_PFAA),
                  s_shape = 1, expand = 0,
                  alpha = 0.3,  show.legend = F)+
    xlab('Modeled log PFAA (ng/kg)')+
    ylab('Observed log PFAA (ng/kg)')#+
```

#### **Figure 5.** 
The results of all predicted values for each PFAA, each species, and system. The encircled area is for a given species.


```{r the effects of temperature, eval = FALSE}


for (i in 1:length(PFAS_List)){
  
  p.t<-ggplot(A[A$PFAA == PFAS_List[i],], aes(x = temperature, y = log_ngkg_re,
                                 group = SppAlias, color = SppAlias))+
    geom_line()+
    scale_fill_viridis_d(name=" ")+
    scale_color_viridis_d(name=" ")+
    theme_minimal()+
    guides(fill = guide_legend(nrow = 2, byrow = T)) +
    theme(legend.direction = "vertical", legend.box = "vertical")+
    theme(axis.text.x = element_text(size = 7))

  p.bw<-ggplot(A[A$PFAA == PFAS_List[i],], aes(x = WB, y = log_ngkg_re,
                                   group = SppAlias, color = SppAlias))+
    geom_point(pch=".")+
    scale_fill_viridis_d(name=" ")+
    scale_color_viridis_d(name=" ")+
    theme_minimal()+
    guides(fill = guide_legend(nrow = 2, byrow = T)) +
    theme(legend.direction = "vertical", legend.box = "vertical")+
    theme(axis.text.x = element_text(size = 7))+
    facet_wrap(.~system, scales = "free")+
    geom_smooth(color = "black")

  p.gv<-ggplot(A[A$PFAA == PFAS_List[i],], aes(x = G_V, y = log_ngkg_re,
                                   group = SppAlias,
                                   color = SppAlias,
                                   alpha = temperature))+
    geom_point(pch=".")+
    scale_fill_viridis_d(name=" ")+
    scale_color_viridis_d(name=" ")+
    theme_minimal()+
    guides(fill = guide_legend(nrow = 2, byrow = T)) +
    theme(legend.direction = "vertical", legend.box = "vertical")+
    theme(axis.text.x = element_text(size = 7))+
    facet_wrap(.~system, scales = "free")+
    geom_smooth(color = "black")
  
  p.gd<-ggplot(A[A$PFAA == PFAS_List[i],], aes(x = G_D, y = log_ngkg_re,
                                   group = SppAlias,
                                   color = SppAlias,
                                   alpha = temperature))+
    geom_point(pch=".")+
    scale_fill_viridis_d(name=" ")+
    scale_color_viridis_d(name=" ")+
    theme_minimal()+
    guides(fill = guide_legend(nrow = 2, byrow = T)) +
    theme(legend.direction = "vertical", legend.box = "vertical")+
    theme(axis.text.x = element_text(size = 7))+
    facet_wrap(.~system, scales = "free")+
    geom_smooth(color = "black", linewidth = 0.5)
  
  assign(paste("p.t_", PFAS_List[i], sep =""), p.t)
  assign(paste("p.bw_", PFAS_List[i], sep =""), p.bw)
  assign(paste("p.gv_", PFAS_List[i], sep =""), p.gv)
  assign(paste("p.gd_", PFAS_List[i], sep =""), p.gd)
  
}

# cowplot::plot_grid(p.t_PFHxS + theme(legend.position = "none"),
#                    p.t_PFOS + theme(legend.position = "none"),
#                    p.t_PFNA + theme(legend.position = "none"),
#                    p.t_PFOA + theme(legend.position = "none"), 
#                    p.t_PFOS + theme(legend.position = "none"), 
#                    legend, labels = c("PFHxS", "PFOS", "PFNA",
#                                       "PFOA", "PFOA", ""),
#                    label_size = 8,
#                    label_x = c(0.8, 0.8),
#                    label_y = c(0.9, 0.9),
#                    nrow = 3, ncol = 2)

```

<!-- Ventilation rates:  -->

```{r g_v plot, eval = FALSE}

cowplot::plot_grid(p.gv_PFHxS + theme(legend.position = "none", axis.title = element_blank()),
                   p.gv_PFOS + theme(legend.position = "none", axis.title = element_blank()),
                   p.gv_PFNA + theme(legend.position = "none", axis.title.x = element_blank()),
                   p.gv_PFOA + theme(legend.position = "none", axis.title = element_blank()), 
                   p.gv_PFOS + theme(legend.position = "none", axis.title.y = element_blank()), 
                   legend, labels = c("PFHxS", "PFOS", "PFNA",
                                      "PFOA", "PFOA", ""),
                   label_size = 8,
                   label_x = c(0.8, 0.8),
                   label_y = c(0.9, 0.9),
                   nrow = 5, ncol = 1)


```

<!-- Feeding rates:  -->

```{r g_d plot, eval = F}

cowplot::plot_grid(p.gd_PFHxS + theme(legend.position = "none", axis.title = element_blank()),
                   p.gd_PFOS + theme(legend.position = "none", axis.title = element_blank()),
                   p.gd_PFNA + theme(legend.position = "none", axis.title.x = element_blank()),
                   p.gd_PFOA + theme(legend.position = "none", axis.title = element_blank()), 
                   p.gd_PFOS + theme(legend.position = "none", axis.title.y = element_blank()), 
                   legend, labels = c("PFHxS", "PFOS", "PFNA",
                                      "PFOA", "PFOA", ""),
                   label_size = 8,
                   label_x = c(0.8, 0.8),
                   label_y = c(0.9, 0.9),
                   nrow = 5, ncol = 1)

```



