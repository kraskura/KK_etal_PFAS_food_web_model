---
title: "Error estimates"
subtitle: "What is good enough?"
author: "K. Kraskura"
date: "`r Sys.Date()`"
output: 
  # pdf_document:
  html_document:
    toc: true
    toc_float: true
    toc_collapsed: false
    toc_depth: 4
    theme: journal
    code_folding: hide
editor_options: 
  chunk_output_type: console
---


```{r setup}
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE)
```

<br/>

### Objectives:

### Error anaylsis: what is good enough?

-  To run error analysis taking a random one selection of species, water and sediment samples

- What is the variation in diet and water uptake proportions across all Monte Carlo simulations. 

<br/>

### Preliminary results:

- **Even with the range of empirical values recorded (species mass, temperature, PFAA tissue, sediment and water concentrations), the predicted PFAA tissue bioconcentrations are predicted within a narrow range.** The model robustly predicts the PFAA biocenenctrations. 
  * Monte Carlo Method to estimate mean +/- SD in species specific PFAA bioconcentrations
  * The factors that contribute to the mismatch between measured and modeled predicted values are unknown and like mechanistic (species specific) and ecological (organic carbon content, other factors).
  
- Temperature ranged only between ~ 20.1 and 20.7. No change in results within that range. 
- Ventilation rate resembles the effect of body mass. Body mass does not affect bioaccumulation.
- Feeding rate positively affects bioaccumulation in neaerly all species. 

```{r source, warning=FALSE, message=FALSE, echo=TRUE}

library(kableExtra)
library(dplyr)
library(tidyverse)
library(broom)
library(tidyr)
library(ggplot2)
library(ggridges)
library(reshape)
library(tibble) # needed to get named list of dataframes (in data_tables.R)
library(readxl)
library(MCMCglmm)
library(ggsci)
library(ggalt)
library(tictoc)
library(here)
library(ggformat2) # kk custom function for ggplot


# functions to run food web model
source(here("Code/R model/PFAS_bioaccum_v2.R")) 
source(here("Code/R model/PFAS_classes_v2.R"))
source(here("Code/R model/PFAS_steadyState_v2.R"))
source(here("Code/R model/runEcosystemModels.R")) # custom written
source(here("Code/R model/runErrorEstimates.R"))
source(here("Code/R model/data_tables.R"))
source(here("Code/R model/data_MonteCarlo.R"))
source(here("Code/R model/mc_sim_data_table.R"))

# source data tables for each objective
kRTable = read.csv(here("Data", "export_krTable.csv"), row.names = "X", header = T)
colnames(kRTable)<-c("kr/kb", "PFAA", "chemID")
PFAS_List <- c('PFHxS','PFOS','PFOA','PFNA','PFDA','PFUA')
PFAS_labels <- c('C6 PFSA','C8 PFSA','C8 PFCA', 'C9 PFCA','C10 PFCA','C11 PFCA')
PFAA_cols <- c('PFHxS' = '#332288', # 
             'PFOS' = '#882255', # 
             'PFOA' = '#117733',
             'PFNA' = '#88CCEE',
             'PFDA' = 'orange',
             'PFUA' = '#AA4499')

p_lines <- data.frame('x' = c(0, 7),
                      'y' = c(0, 7))
p_lines$y1 <- p_lines$x-1
p_lines$y2 <- p_lines$x+1
p_lines$y3 <- p_lines$x-log10(2)
p_lines$y4 <- p_lines$x+log10(2)

```

```{r select n interations for chunks below}
n_iterations_mcmc<-1
```

```{r mcmc run modeled diet, eval=TRUE, message = FALSE}
# settings_obsDiet = new_Settings(
#   chooseDiet = 'forced',
# )

settings_modelDiet = new_Settings(
  chooseDiet = 'default',
  chooseKoc = 'Koc',
  chooseDmw = "Droge", # default = "Droge", or use "calculated" 
  chooseEw = "empirical", # default = 'empirical', or use "beta#", where:
  # must be in format: beta#, #beta [# = numeric var, no spaces, no special char]"
)


tic("Observed PFAA in Diet: random sampling MCMC models for all systems")

message("Analyzing JAB Summer")
A.jba.sum<-mcmc_input_files(location = "JBA",
                    season = "Summer", 
                    species_list = c("Dac",	"Dar",	"Min",	"Fal",	"Bas",	"Mad",	"Pum",	"Swa"),
                    PFAAs = c("PFHxS", "PFOS", "PFOA", "PFNA", "PFDA", "PFUA"),
                    n_iter = n_iterations_mcmc,
                    settings_modelDiet = settings_modelDiet)


message("Analyzing JAB Spring")
A.jba.sp<-mcmc_input_files(location = "JBA",
                    season = "Spring", 
                    species_list = c("Kil"	,"Chu",	"Dac", "Dar",	"Min",	"Mad",	"Pum",	"Swa"),
                    PFAAs = c("PFHxS", "PFOS", "PFOA", "PFNA", "PFDA", "PFUA"),
                    n_iter = n_iterations_mcmc,
                    settings_modelDiet = settings_modelDiet)

message("Analyzing WG")
A.wg<-mcmc_input_files(location = "WG",
                    season = "Fall", 
                    species_list = c("Pry", "Bgl", "Bas"),
                    PFAAs = c("PFHxS", "PFOS", "PFOA", "PFNA", "PFDA", "PFUA"),
                    n_iter = n_iterations_mcmc,
                    settings_modelDiet = settings_modelDiet)

toc()

A.jba.sp$loc<-"JBA"
A.jba.sum$loc<-"JBA"
A.wg$loc<-"WG"
A.jba.sum$Seasonality<-"Summer"
A.jba.sp$Seasonality<-"Spring"
A.wg$Seasonality<-"Fall"
A<-rbind(A.jba.sp, A.jba.sum, A.wg)
write.csv(A, here("Data","outputs", "mcmc_replicate_runs_modeledDiet.csv"))

```

```{r mcmc run observed diet , eval=FALSE, message = FALSE}

# PFAS are known in each diet item
settings_obsDiet = new_Settings(
  chooseDiet = 'forced', # known PFAA in diet
  chooseKoc = 'Koc',
  chooseDmw = "Droge",
  chooseEw = "empirical"
)

tic("Modeled PFAA in Diet: random sampling MCMC models for all systems")
message("Analyzing JAB Summer")
A.jba.sumO<-mcmc_input_files(location = "JBA",
                    season = "Summer", 
                    species_list = c("Dac",	"Dar",	"Min",	"Fal",	"Bas",	"Mad",	"Pum",	"Swa"),
                    PFAAs = c("PFHxS", "PFOS", "PFOA", "PFNA", "PFDA", "PFUA"),
                    n_iter = n_iterations_mcmc,
                    settings_obsDiet = settings_obsDiet)

message("Analyzing JAB Spring")
A.jba.spO<-mcmc_input_files(location = "JBA",
                    season = "Spring", 
                    species_list = c("Kil"	,"Chu",	"Dac", "Dar",	"Min",	"Mad",	"Pum",	"Swa"),
                    PFAAs = c("PFHxS", "PFOS", "PFOA", "PFNA", "PFDA", "PFUA"),
                    n_iter = n_iterations_mcmc,
                    settings_obsDiet = settings_obsDiet)

message("Analyzing WG")
A.wgO<-mcmc_input_files(location = "WG",
                    season = "Fall", 
                    species_list = c("Pry", "Bgl", "Bas"),
                    PFAAs = c("PFHxS", "PFOS", "PFOA", "PFNA", "PFDA", "PFUA"),
                    n_iter = n_iterations_mcmc,
                    settings_obsDiet = settings_obsDiet)

toc()

A.jba.spO$loc<-"JBA"
A.jba.sumO$loc<-"JBA"
A.wgO$loc<-"WG"
A.jba.sumO$Seasonality<-"Summer"
A.jba.spO$Seasonality<-"Spring"
A.wgO$Seasonality<-"Fall"
AO<-rbind(A.jba.spO, A.jba.sumO, A.wgO)
write.csv(AO, here("Data","outputs","mcmc_replicate_runs_observedDiet.csv"))

```

```{r read in and organize saved data}

# A<-read.csv(file = here("Data/outputs/mcmc_replicate_runs_modeledDiet.csv")) # trophic transfer 
# AO<-read.csv(file = here("Data/outputs/mcmc_replicate_runs_observedDiet.csv")) # known diet 

# set percent error: 
pct<-0.3
A$Obs_logngkg_percUP <- log10((pct * A$Obs_ngg*1000) + (A$Obs_ngg*1000)) # ng/kg
A$Obs_logngkg_percLO <- log10((A$Obs_ngg*1000) - (pct * A$Obs_ngg*1000))
# AO$Obs_logngkg_percUP <- log10((pct * AO$Obs_ngg*1000) + (AO$Obs_ngg*1000))
# AO$Obs_logngkg_percLO <- log10((AO$Obs_ngg*1000) - (pct * AO$Obs_ngg*1000))

A<-A[!c(A$PFAA == "PFUA" | A$PFAA == "PFDA"),]
A$system<-paste(A$loc, A$Seasonality, sep =" ")
# AO<-AO[!c(AO$PFAA == "PFUA" | AO$PFAA == "PFDA"),]
# AO$system<-paste(AO$loc, AO$Seasonality, sep =" ")

# AO$spp_PFAA<-paste(AO$SppAlias, AO$PFAA, sep =" ")
A$spp_PFAA<-paste(A$SppAlias, A$PFAA, sep =" ")


```


### Error estimated for modeled diet

```{r model bias calc modeled diet}
A$mb_avg<-NA
A$mb_cv<-NA
A$r2<-NA
A$mb_avg_pct<-NA
A$runID<-paste(A$iteration, A$system, sep = "-")
split_data<-split(x = A, f = as.factor(A$runID))

for (i in 1:length(split_data)){
  
  data0<-data.frame(split_data[i])
  colnames(data0)<-colnames(A)
  mb_run<-estimate_error(MetricData = data0, DataID = data0$runID)
  mb0<-mb_run[[1]]
  mbcv0<-mb_run[[2]]
  r20<-mb_run[[3]]
  mb_pct0<-mb_run[[6]]
  
  A[which(A$runID == data0$runID[1]),"mb_avg"]<-mb0
  A[which(A$runID ==data0$runID[1]),"mb_cv"]<-mbcv0
  A[which(A$runID ==data0$runID[1]),"r2"]<-r20 
  A[which(A$runID == data0$runID[1]),"mb_avg_pct"]<-mb_pct0
}
```

```{r PART 2 in SERDP report error estimate figure}

# histogram of all model bias (cv) 
p3.cv<-ggformat(
  plot = ggplot(A[!duplicated(A$mb_cv),],
        aes(x = mb_cv, color = NULL))+
        geom_histogram(bins =100, color=NA)+
        scale_fill_manual(values = PFAA_cols)+
        geom_vline(xintercept = 1, linetype = 1)+
        facet_grid(system~.)+
        theme_bw(),
  y_title = "N model runs", x_title = "Model Bias (CV)", size_text = 12)


# histogram of all model bias (avg) 
p3<-ggformat(
  plot = ggplot(A[!duplicated(A$mb_avg),],
        aes(x = mb_avg, color = NULL))+
        geom_histogram(bins =100, color=NA)+
        scale_fill_manual(values = PFAA_cols)+
        geom_vline(xintercept = 1, linetype = 1)+
        facet_grid(system~.)+
        theme_bw(),
  y_title = "N model runs", x_title = "Model Bias (avg)", size_text = 12)

# histogram of all model bias % difference
p3.pct<-ggformat(
  plot = ggplot(A[!duplicated(A$mb_avg_pct),],
        aes(x = mb_avg_pct, color = NULL))+
        geom_histogram(bins =100, color=NA)+
        scale_fill_manual(values = PFAA_cols)+
        geom_vline(xintercept = 1, linetype = 1)+
        facet_grid(system~.)+
        geom_vline(color = "red", xintercept = c(30, -30))+
        theme_bw(),
  y_title = "N model runs", x_title = "Model Bias (% difference)", size_text = 12)

# plotting:
# the difference in log observed and lof predicted values for each species

for (i in 1:length(PFAS_List)){
  
  if(PFAS_List[i] == "PFUA" ){
    next
  }
  # used data (A) is with predictions using trophic transfer estimates
  A.0<-(A[A$PFAA == PFAS_List[i] & !c(A$SppAlias == "Phy") ,])
  
  plot <- ggplot(data = A.0, aes(x = log_ngkg_re- Obs_logngkg,
                                 y = SppAlias,
                                 group = SppAlias,
                                 fill= PFAA, 
                                 color = PFAA))+
    geom_density_ridges(bins = 100, alpha = 0.8,
                        scale = 0.9,
                        rel_min_height = 0.01)+
    scale_fill_manual(name=" ", values = PFAA_cols)+
    scale_color_manual(name=" ", values = PFAA_cols)+
    facet_grid(.~system)+
    geom_vline(xintercept = 0)+
    theme_minimal()+
    guides(fill = guide_legend(nrow = 3, byrow = T)) +
    theme(legend.direction = "vertical", legend.box = "vertical")+
    theme(axis.text.x = element_text(size = 7), 
          axis.title.y = element_blank())+
    xlab("Diff bioconc (log(Pred) - log(Obs))")
          # axis.title.x = element_blank())
  

  # summary stats A.3 is a summary table for A.0 (output table for known diet)
  A.3 <- A.0 %>%
          group_by(SppAlias, PFAA, system) %>%
          summarise(mean_val = mean(Obs_logngkg, na.rm = TRUE),
                    mean_errUP = max(Obs_logngkg, na.rm = TRUE),
                    mean_errLO = min(Obs_logngkg, na.rm = TRUE),
                    mean_val2 = mean(log_ngkg_re, na.rm = TRUE),
                    max_val2 = max(log_ngkg_re, na.rm = TRUE),
                    min_val2 = min(log_ngkg_re, na.rm = TRUE))
  
  plot2 <-
    ggplot(data = A.0, aes(x = log_ngkg_re,
                      y = SppAlias,
                      color = PFAA, fill = PFAA))+
    # geom_density_ridges(stat = "binline", bins = 100, scale = 0.95, draw_baseline = FALSE)+
    geom_errorbarh(data = A.3[!c(A.3$SppAlias == "Phy"),],
          mapping = aes(x = mean_val, xmax = mean_errUP, xmin = mean_errLO, color = PFAA),
          height = 0.2, color = "black")+
    geom_density_ridges( draw_baseline = FALSE, alpha = 0.8,
                         scale = 0.9,
                         rel_min_height = 0.01)+
    # xlim(1, 7)+
    scale_fill_manual(name=" ", values = PFAA_cols)+
    scale_color_manual(name=" ", values = PFAA_cols)+
    theme_minimal()+
    facet_grid(.~system)+
    guides(fill = guide_legend(nrow = 2, byrow = T)) +
    theme(legend.direction = "vertical", legend.box = "vertical")+
    theme(axis.text.x = element_text(size = 7), 
          axis.title.y = element_blank())+
    xlab("Tissue bioconcentrations")
          
          # axis.title.x = element_blank())
    
  
  assign(paste("p_", PFAS_List[i], sep = ""), plot)
  assign(paste("p2_", PFAS_List[i], sep = ""), plot2)
 
}

legend <- cowplot::get_legend(
  # create some space to the left of the legend
  p_PFOS + theme(legend.box.margin = margin(0, 0, 0, 12))
)
legend2 <- cowplot::get_legend(
  # create some space to the left of the legend
  p2_PFOS + theme(legend.box.margin = margin(0, 0, 0, 12))
)
# ('PFHxS','PFOS','PFOA','PFNA','PFDA','PFUA')
# PFAS_labels <- c('C6 PFSA','C8 PFSA','C8 PFCA', 'C9 PFCA','C10 PFCA','C11 PFCA')
```

```{r PART 2 in REPORT figure 2, fig.height = 9, fig.width=6, eval = T, fig.cap="Figure 1."}

p_PFHxS<-p_PFHxS+theme(axis.title.x = element_blank(), legend.position = "none")
p_PFOS<-p_PFOS+theme(axis.title.x = element_blank(), legend.position = "none", 
                     strip.background = element_blank(), strip.text.x = element_blank())
p_PFNA<-p_PFNA+theme(axis.title.x = element_blank(), legend.position = "none", 
                     strip.background = element_blank(), strip.text.x = element_blank())
p_PFOA<-p_PFOA+theme( legend.position = "none", strip.background = element_blank(), strip.text.x = element_blank())

col1<-cowplot::plot_grid(p_PFHxS,
                   p_PFOS ,
                   p_PFNA ,
                   p_PFOA , 
                   # p_PFDA + theme(legend.position = "none"), # "PFHxS", "PFOS", "PFOA", "PFNA", "PFDA", "PFUA"
                    labels = c("PFHxS", "PFOS", "PFNA",
                                      "PFOA", ""),
                   label_size = 10,
                   label_x = c(0.8),
                   label_y = c(0.83, 0.83, 0.83, 0.83),
                   nrow = 4, ncol = 1)
bothcols<-cowplot::plot_grid(col1, p3, p3.cv,p3.pct,
                             align = "hv",
                             nrow = 1,
                             labels = "AUTO")
ggsave(height = 7, width = 12, filename = here("Figures/Figure2_part2.png"))

```

The difference between model estimated PFAA value and observed (empirically measured values) for each PFAA, species, and in each system. The vertical line at 0 indicates "perfect" agreement between measured and modeled values. The density plots compile model results originated from taking 1000 random draws of realistically measurable values in each system (the randomly selected values include: water, sediment, and species tissue PFAA concentrations, and water temperature; all other parameters were constant). **Only showing results for model runs where PFAA values in diet were modeled via trophic transfer**

<br/>
<br/>

```{r visualizing results plot2, fig.height = 12, fig.width=6, fig.cap="Figure 2."}
cowplot::plot_grid(p2_PFHxS + theme(legend.position = "none"),
                   p2_PFOS + theme(legend.position = "none"),
                   p2_PFNA + theme(legend.position = "none"),
                   p2_PFOA + theme(legend.position = "none"), 
                   # p_PFDA + theme(legend.position = "none"), # "PFHxS", "PFOS", "PFOA", "PFNA", "PFDA", "PFUA"
                    labels = c("PFHxS", "PFOS", "PFNA",
                                      "PFOA",  ""),
                   label_size = 10,
                   label_x = c(0.87),
                   label_y = c(0.86, 0.86, 0.86, 0.86),
                   nrow = 4, ncol = 1)
```



The distributions of predicted PFAA tissue bioconcentration values, the error bar mark the range of the empirically measured value.
The density plots compile model results originated from taking 1000 random draws of realistically measurable values in each system (the randomly selected values include: water, sediment, and species tissue PFAA concentrations, and water temperature; all other parameters were constant). **Only showing results for model runs where PFAA values in diet were modeled via trophic transfer**


<br/>
<br/>


```{r visualizing full results modeled PFAA diet,fig.cap="Figure 3.", fig.height=3.5, fig.width=9.5}
# DataList$PFAA<-factor(DataList$PFAA)

ggplot(data = A, aes(x = log_ngkg_re, y = Obs_logngkg, color = PFAA))+
    geom_line(data = p_lines, mapping = aes(x = x, y = y),
              linetype = 1, linewidth = 0.5, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y1),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y2),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y3),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y4),
              linetype = 3, linewidth = 0.2, color = "black")+
    facet_grid(.~system)+
    # geom_errorbar(aes(ymin = Obs_logngkg - Obs_logngkg_Lo, ymax = Obs_logngkg + Obs_logngkg_Up), size = 0.5) +
    # geom_errorbarh(aes(xmin = log_ngkg_re - logngkg_Lo, xmax = log_ngkg_re + logngkg_Up), size = 0.5) + +
    geom_encircle(aes(fill = PFAA, color = PFAA), s_shape = 1, expand = 0,
                  alpha = 0.3,  show.legend = FALSE)+
    geom_point(pch = 19, size = 0.01)+
    theme_bw()+
    scale_color_manual(values = PFAA_cols)+
    scale_fill_manual(values = PFAA_cols)+
    ggtitle(label = 'Modeled PFAAs in diet: trophic transfer')+
    xlab('Modeled log PFAA (ng/kg)')+
    ylab('Observed log PFAA (ng/kg)')#+
    # coord_cartesian(ylim = c(2,6.5), xlim = c(2,6.5))+
    # theme(legend.position = "none")
# p1_fish


```


<!-- The results of all predicted values for each PFAA, and system. Each dot represents a species. The colored polygons connect each PFAA -->

```{r visualizing full results observed PFAA diet, fig.cap= "Figure 5.", fig.height=3.5, fig.width=9.5, eval=FALSE}
# DataList$PFAA<-factor(DataList$PFAA)

ggplot(data = AO, aes(x = log_ngkg_re, y = Obs_logngkg, color = PFAA))+
    geom_line(data = p_lines, mapping = aes(x = x, y = y),
              linetype = 1, linewidth = 0.5, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y1),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y2),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y3),
              linetype = 3, linewidth = 0.2, color = "black")+
    geom_line(data = p_lines, mapping = aes(x = x, y = y4),
              linetype = 3, linewidth = 0.2, color = "black")+
    facet_grid(.~system)+
    # geom_errorbar(aes(ymin = Obs_logngkg - Obs_logngkg_Lo, ymax = Obs_logngkg + Obs_logngkg_Up), size = 0.5) +
    # geom_errorbarh(aes(xmin = log_ngkg_re - logngkg_Lo, xmax = log_ngkg_re + logngkg_Up), size = 0.5) + +
    geom_encircle(aes(fill = PFAA, color = PFAA), s_shape = 1, expand = 0,
                  alpha = 0.3,  show.legend = FALSE)+
    geom_point(pch = 19, size = 0.01)+
    theme_bw()+
    scale_color_manual(values = PFAA_cols)+
    scale_fill_manual(values = PFAA_cols)+
    ggtitle(label = 'Known PFAAs in diet')+
    xlab('Modeled log PFAA (ng/kg)')+
    ylab('Observed log PFAA (ng/kg)')#+
    # coord_cartesian(ylim = c(2,6.5), xlim = c(2,6.5))+
    # theme(legend.position = "none")
# p1_fish


```

<!-- The results of all predicted values for each PFAA, and system. Each dot represents a species. The colored polygons connect each PFAA -->

```{r PART 2 SERDP report  figure 3, fig.height=3.5, fig.width=9, fig.cap="Figure 5."}

# spp_avgO<-AO %>% # observed; known PFAA in diet
#   group_by(spp_PFAA, system, SppAlias, PFAA) %>% 
#   dplyr:::summarize(mean_pred = mean(log_ngkg_re), 
#                     sd_pred = sd(log_ngkg_re), 
#                     min_pred = min(log_ngkg_re),
#                     max_pred = max(log_ngkg_re),
#                     mean_obs = mean(Obs_logngkg), 
#                     sd_obs = sd(Obs_logngkg),
#                     min_obs = min(Obs_logngkg),
#                     max_obs = max(Obs_logngkg))

spp_avg<-A %>% # trophic transfer
  group_by(spp_PFAA, system, SppAlias, PFAA) %>% 
  dplyr:::summarize(mean_pred = mean(log_ngkg_re), 
                    sd_pred = sd(log_ngkg_re), 
                    min_pred = min(log_ngkg_re),
                    max_pred = max(log_ngkg_re),
                    mean_obs = mean(Obs_logngkg), 
                    sd_obs = sd(Obs_logngkg),
                    min_obs = min(Obs_logngkg),
                    max_obs = max(Obs_logngkg))

 
# ggformat(p2, y_title = ('Measured log PFAS (ng/kg)'), x_title = 'Modeled log PFAS (ng/kg)', size_text = 12, print = F, title = '')
# p2<-p2+theme(legend.position = "none", 
#              axis.title.x = element_blank())



main1_p1<- ggplot(data = spp_avg, aes(x = mean_pred, y = mean_obs,
                      fill = PFAA, shape = system))+
    geom_line(data = p_lines, mapping = aes(x = x, y = y, fill = NULL,shape = NULL),
              linetype = 1, linewidth = 0.5)+
    geom_line(data = p_lines, mapping = aes(x = x, y = y1, fill = NULL,shape = NULL),
              linetype = 3, linewidth = 0.2)+
    geom_line(data = p_lines, mapping = aes(x = x, y = y2, fill = NULL,shape = NULL),
              linetype = 3, linewidth = 0.2)+
    geom_line(data = p_lines, mapping = aes(x = x, y = y3, fill = NULL,shape = NULL),
              linetype = 3, linewidth = 0.2)+
    geom_line(data = p_lines, mapping = aes(x = x, y = y4, fill = NULL,shape = NULL),
              linetype = 3, linewidth = 0.2)+
    facet_grid(.~system)+
    scale_shape_manual(values = c(22, 21, 23))+
    theme_bw()+
    coord_cartesian(ylim = c(1,7), xlim = c(1,7))+
    geom_errorbar(mapping = aes(ymin = min_obs, ymax = max_obs, color = PFAA),
                  linewidth = 0.3)+
    geom_errorbarh(mapping = aes(xmin = min_pred , xmax = max_pred, color = PFAA),
                   linewidth = 0.3)+
    geom_point(size = 1, color = "black", alpha = 1, stroke = 0.1)+
    theme_bw()+
    scale_color_manual(values = PFAA_cols)+
    scale_fill_manual(values = PFAA_cols)+
    ggtitle(label = 'Trophic transfer of PFAA')+
    xlab('Modeled log PFAA (ng/kg)')+
    ylab('Observed log PFAA (ng/kg)')#+


main1_p1<-ggformat(main1_p1, y_title = 'Observed log PFAA (ng/kg)',
                   x_title = 'Modeled log PFAA (ng/kg)', size_text = 12)
main1_p1<-main1_p1+theme(legend.position = "none")
ggsave(height = 3.5, width = 8, filename = here("Figures/Figure3_part2.png"))

# cowplot::plot_grid(main1_p1, main1_p2, 
#                    nrow = 2)

```


<!-- The results of all predicted values for each PFAA, each species, and system. The encircled area is for a given species. The Polygons wrap each species and PFAA. -->

```{r the distribution of sampled data, eval = FALSE}

# willow grove data
source(here("Code", "R data tables", "WG.R"))

p.PFHxS<-ggplot()+
  geom_point(data  = d.water, aes(x = PFHxS.m/1000, y =1), # ng/mL
             color  = PFAA_cols["PFHxS"], pch = 16)+
  annotate(geom = "segment", x = d.water$PFHxS.min/1000, xend = d.water$PFHxS.max/1000,
           y = 1, yend = 1, color  = PFAA_cols["PFHxS"])+
  # annotate(geom = "text", label = n.water, x = 4,
  #          y = 1, color  = PFAA_cols["PFHxS"] ,size=3)+  
  geom_point(data  = d.sed, aes(x = PFHxS.m, y =2), # ng/g
             color  = PFAA_cols["PFHxS"], pch = 1)+
  annotate(geom = "segment", x = d.sed$PFHxS.min, xend = d.sed$PFHxS.max,
           y = 2, yend = 2, color  = PFAA_cols["PFHxS"])+
  # annotate(geom = "text", label = n.water, x = 4, 
  #          y = 2, color  = PFAA_cols["PFHxS"] ,size=3)+  
  xlim(0, 4)

p.PFOS<-ggplot()+
  geom_point(data  = d.water, aes(x = PFOS.m/1000, y =1), # ng/mL
             color  = PFAA_cols["PFOS"], pch = 16)+
  annotate(geom = "segment", x = d.water$PFOS.min/1000, xend = d.water$PFOS.max/1000,
           y = 1, yend = 1, color  = PFAA_cols["PFOS"])+
  geom_point(data  = d.sed, aes(x = PFOS.m, y =2), # ng/g
             color  = PFAA_cols["PFOS"], pch = 1)+
  annotate(geom = "segment", x = d.sed$PFOS.min, xend = d.sed$PFOS.max,
           y = 2, yend = 2, color  = PFAA_cols["PFOS"])+
  xlim(0, 60)


p.PFOA<-ggplot()+
  geom_point(data  = d.water, aes(x = PFOA.m/1000, y =1), # ng/mL
             color  = PFAA_cols["PFOA"], pch = 16)+
  annotate(geom = "segment", x = d.water$PFOA.min/1000, xend = d.water$PFOA.max/1000,
           y = 1, yend = 1, color  = PFAA_cols["PFOA"])+
  geom_point(data  = d.sed, aes(x = PFOA.m, y =2), # ng/g
             color  = PFAA_cols["PFOA"], pch = 1)+
  annotate(geom = "segment", x = d.sed$PFOA.min, xend = d.sed$PFOA.max,
           y = 2, yend = 2, color  = PFAA_cols["PFOA"])+
  xlim(0, 1)

p.PFNA<-ggplot()+
  geom_point(data  = d.water, aes(x = PFNA.m/1000, y =1), # ng/mL
             color  = PFAA_cols["PFNA"], pch = 16)+
  annotate(geom = "segment", x = d.water$PFNA.min/1000, xend = d.water$PFNA.max/1000,
           y = 1, yend = 1, color  = PFAA_cols["PFNA"])+
  geom_point(data  = d.sed, aes(x = PFNA.m, y =2), # ng/g
             color  = PFAA_cols["PFNA"], pch = 1)+
  annotate(geom = "segment", x = d.sed$PFNA.min, xend = d.sed$PFNA.max,
           y = 2, yend = 2, color  = PFAA_cols["PFNA"])+
  xlim(0, 0.5)

p.PFDA<-ggplot()+
  geom_point(data  = d.water, aes(x = PFDA.m/1000, y =1), # ng/mL
             color  = PFAA_cols["PFDA"], pch = 16)+
  annotate(geom = "segment", x = d.water$PFDA.min/1000, xend = d.water$PFDA.max/1000,
           y = 1, yend = 1, color  = PFAA_cols["PFDA"])+
  geom_point(data  = d.sed, aes(x = PFDA.m, y =2), # ng/g
             color  = PFAA_cols["PFDA"], pch = 1)+
  annotate(geom = "segment", x = d.sed$PFDA.min, xend = d.sed$PFDA.max,
           y = 2, yend = 2, color  = PFAA_cols["PFDA"])+
  xlim(0, 0.025)
# 
# p.PFHxS.sp<-ggplot(data = d.fish)+
#   geom_point(aes(x = PFHxS.m, y = Sp), # ng/mL
#              color  = PFAA_cols["PFHxS"], pch = 19)+
#   geom_errorbarh(mapping = aes(xmin = PFHxS.min, xmax = PFHxS.max, y = Sp),
#                  color  = PFAA_cols["PFHxS"], height = 0)+
#   geom_text(data = n.fish, datageom = "text", label = n.fish, x = 3,
#            y = 1, color  = PFAA_cols["PFHxS"])

# JBA spring data
source(here("Code", "R data tables", "JBA_spring.R"))
p.PFHxS <- p.PFHxS+ 
  geom_point(data  = d.water, aes(x = PFHxS.m/1000, y =1.2),
             color  = PFAA_cols["PFHxS"], pch = 17)+
  annotate(geom = "segment", x = d.water$PFHxS.min/1000, xend = d.water$PFHxS.max/1000,
           y = 1.2, yend = 1.2, color  = PFAA_cols["PFHxS"])+
  annotate(geom = "text", label = n.water, x = 4,
           y = 1.2, color  = PFAA_cols["PFHxS"] ,size=3)+
  geom_point(data  = d.sed, aes(x = PFHxS.m, y =2.2), # ng/g
             color  = PFAA_cols["PFHxS"], pch = 2)+
  annotate(geom = "segment", x = d.sed$PFHxS.min, xend = d.sed$PFHxS.max,
           y = 2.2, yend = 2.2, color  = PFAA_cols["PFHxS"])+
  annotate(geom = "text", label = n.water, x = 4, 
           y = 2.2, color  = PFAA_cols["PFHxS"],size=3)

p.PFOS <- p.PFOS+ 
  geom_point(data  = d.water, aes(x = PFOS.m/1000, y =1.2),
             color  = PFAA_cols["PFOS"], pch = 17)+
  annotate(geom = "segment", x = d.water$PFOS.min/1000, xend = d.water$PFOS.max/1000,
           y = 1.2, yend = 1.2, color  = PFAA_cols["PFOS"])+
  geom_point(data  = d.sed, aes(x = PFOS.m, y =2.2), # ng/g
             color  = PFAA_cols["PFOS"], pch = 2)+
  annotate(geom = "segment", x = d.sed$PFOS.min, xend = d.sed$PFOS.max,
           y = 2.2, yend = 2.2, color  = PFAA_cols["PFOS"])

p.PFOA <- p.PFOA+ 
  geom_point(data  = d.water, aes(x = PFOA.m/1000, y =1.2),
             color  = PFAA_cols["PFOA"], pch = 17)+
  annotate(geom = "segment", x = d.water$PFOA.min/1000, xend = d.water$PFOA.max/1000,
           y = 1.2, yend = 1.2, color  = PFAA_cols["PFOA"])+
  geom_point(data  = d.sed, aes(x = PFOA.m, y =2.2), # ng/g
             color  = PFAA_cols["PFOA"], pch = 2)+
  annotate(geom = "segment", x = d.sed$PFOA.min, xend = d.sed$PFOA.max,
           y = 2.2, yend = 2.2, color  = PFAA_cols["PFOA"])

p.PFNA <- p.PFNA+ 
  geom_point(data  = d.water, aes(x = PFNA.m/1000, y =1.2),
             color  = PFAA_cols["PFNA"], pch = 17)+
  annotate(geom = "segment", x = d.water$PFNA.min/1000, xend = d.water$PFNA.max/1000,
           y = 1.2, yend = 1.2, color  = PFAA_cols["PFNA"])+
  geom_point(data  = d.sed, aes(x = PFNA.m, y =2.2), # ng/g
             color  = PFAA_cols["PFNA"], pch = 2)+
  annotate(geom = "segment", x = d.sed$PFNA.min, xend = d.sed$PFNA.max,
           y = 2.2, yend = 2.2, color  = PFAA_cols["PFNA"])

p.PFDA <- p.PFDA+ 
  geom_point(data  = d.water, aes(x = PFDA.m/1000, y =1.2),
             color  = PFAA_cols["PFDA"], pch = 17)+
  annotate(geom = "segment", x = d.water$PFDA.min/1000, xend = d.water$PFDA.max/1000,
           y = 1.2, yend = 1.2, color  = PFAA_cols["PFDA"])+
  geom_point(data  = d.sed, aes(x = PFDA.m, y =2.2), # ng/g
             color  = PFAA_cols["PFDA"], pch = 2)+
  annotate(geom = "segment", x = d.sed$PFDA.min, xend = d.sed$PFDA.max,
           y = 2.2, yend = 2.2, color  = PFAA_cols["PFDA"])


# JBA summer data 
source(here("Code", "R data tables", "JBA_summer.R"))
p.PFHxS <- p.PFHxS+ 
  geom_point(data  = d.water, aes(x = PFHxS.m/1000, y =1.4),
             color  = PFAA_cols["PFHxS"], pch = 18)+
  annotate(geom = "segment", x = d.water$PFHxS.min/1000, xend = d.water$PFHxS.max/1000,
           y = 1.4, yend = 1.4, color  = PFAA_cols["PFHxS"])+
  annotate(geom = "text", label = n.water, x = 4,
           y = 1.4, color  = PFAA_cols["PFHxS"] ,size=3)+
  geom_point(data  = d.sed, aes(x = PFHxS.m, y =2.4), # ng/g
             color  = PFAA_cols["PFHxS"], pch = 5)+
  annotate(geom = "segment", x = d.sed$PFHxS.min, xend = d.sed$PFHxS.max,
           y = 2.4, yend = 2.4, color  = PFAA_cols["PFHxS"])+
  annotate(geom = "text", label = n.water, x = 4, 
           y = 2.4, color  = PFAA_cols["PFHxS"],size=3)

p.PFOS <- p.PFOS+ 
  geom_point(data  = d.water, aes(x = PFOS.m/1000, y =1.4),
             color  = PFAA_cols["PFOS"], pch = 18)+
  annotate(geom = "segment", x = d.water$PFOS.min/1000, xend = d.water$PFOS.max/1000,
           y = 1.4, yend = 1.4, color  = PFAA_cols["PFOS"])+
  geom_point(data  = d.sed, aes(x = PFOS.m, y =2.4), # ng/g
             color  = PFAA_cols["PFOS"], pch = 5)+
  annotate(geom = "segment", x = d.sed$PFOS.min, xend = d.sed$PFOS.max,
           y = 2.4, yend = 2.4, color  = PFAA_cols["PFOS"])

p.PFOA <- p.PFOA+ 
  geom_point(data  = d.water, aes(x = PFOA.m/1000, y =1.4),
             color  = PFAA_cols["PFOA"], pch = 18)+
  annotate(geom = "segment", x = d.water$PFOA.min/1000, xend = d.water$PFOA.max/1000,
           y = 1.4, yend = 1.4, color  = PFAA_cols["PFOA"])+
  geom_point(data  = d.sed, aes(x = PFOA.m, y =2.4), # ng/g
             color  = PFAA_cols["PFOA"], pch = 5)+
  annotate(geom = "segment", x = d.sed$PFOA.min, xend = d.sed$PFOA.max,
           y = 2.4, yend = 2.4, color  = PFAA_cols["PFOA"])

p.PFNA <- p.PFNA+ 
  geom_point(data  = d.water, aes(x = PFNA.m/1000, y =1.4),
             color  = PFAA_cols["PFNA"], pch = 18)+
  annotate(geom = "segment", x = d.water$PFNA.min/1000, xend = d.water$PFNA.max/1000,
           y = 1.4, yend = 1.4, color  = PFAA_cols["PFNA"])+
  geom_point(data  = d.sed, aes(x = PFNA.m, y =2.4), # ng/g
             color  = PFAA_cols["PFNA"], pch = 5)+
  annotate(geom = "segment", x = d.sed$PFNA.min, xend = d.sed$PFNA.max,
           y = 2.4, yend = 2.4, color  = PFAA_cols["PFNA"])

p.PFDA <- p.PFDA+ 
  geom_point(data  = d.water, aes(x = PFDA.m/1000, y =1.4),
             color  = PFAA_cols["PFDA"], pch = 18)+
  annotate(geom = "segment", x = d.water$PFDA.min/1000, xend = d.water$PFDA.max/1000,
           y = 1.4, yend = 1.4, color  = PFAA_cols["PFDA"])+
  geom_point(data  = d.sed, aes(x = PFDA.m, y =2.4), # ng/g
             color  = PFAA_cols["PFDA"], pch = 5)+
  annotate(geom = "segment", x = d.sed$PFDA.min, xend = d.sed$PFDA.max,
           y = 2.4, yend = 2.4, color  = PFAA_cols["PFDA"])

ggformat(p.PFHxS, y_title = "", x_title = "", size_text = 10, print = F)
p.PFHxS<-p.PFHxS + scale_y_continuous(breaks = c(1.2, 2.2), labels = c("water", "sediment"))

ggformat(p.PFOS, y_title = "", x_title = "", size_text = 10, print = F)
p.PFOS<-p.PFOS + scale_y_continuous(breaks = c(1.2, 2.2), labels = c("water", "sediment"))

ggformat(p.PFOA, y_title = "", x_title = "", size_text = 10, print = F)
p.PFOA<-p.PFOA + scale_y_continuous(breaks = c(1.2, 2.2), labels = c("water", "sediment"))

ggformat(p.PFNA, y_title = "", x_title = "", size_text = 10, print = F)
p.PFNA<-p.PFNA + scale_y_continuous(breaks = c(1.2, 2.2), labels = c("water", "sediment"))

ggformat(p.PFDA, y_title = "", x_title = "PFAS conc. (ng/g; ng/mL)", size_text = 10, print = F)
p.PFDA<-p.PFDA + scale_y_continuous(breaks = c(1.2, 2.2), labels = c("water", "sediment"))

cowplot::plot_grid(p.PFHxS, p.PFOS, p.PFOA, p.PFDA, p.PFNA, ncol = 3)
# ggsave(height = 4, width = 10, filename = here("Figures/Figure3_part2b.png"))


```



```{r the effects of temperature, eval = FALSE}


for (i in 1:length(PFAS_List)){
  
  p.t<-ggplot(A[A$PFAA == PFAS_List[i],], aes(x = temperature, y = log_ngkg_re,
                                 group = SppAlias, color = SppAlias))+
    # geom_line()+
    geom_point(pch =".")+
    scale_fill_viridis_d(name=" ")+
    scale_color_viridis_d(name=" ")+
    theme_minimal()+
    facet_grid(.~system, scales = "free")+
    guides(fill = guide_legend(nrow = 2, byrow = T)) +
    geom_smooth(method = "lm", se = F)+
    theme(legend.direction = "vertical", legend.box = "vertical")+
    theme(axis.text.x = element_text(size = 7))

  p.bw<-ggplot(A[A$PFAA == PFAS_List[i],], aes(x = WB, y = log_ngkg_re,
                                   group = SppAlias, color = SppAlias))+
    geom_point(pch=".")+
    scale_fill_viridis_d(name=" ")+
    scale_color_viridis_d(name=" ")+
    theme_minimal()+
    geom_smooth(method = "lm", se = F)+
    guides(fill = guide_legend(nrow = 2, byrow = T)) +
    theme(legend.direction = "vertical", legend.box = "vertical")+
    theme(axis.text.x = element_text(size = 7))
    # facet_wrap(.~system, scales = "free")

  p.gv<-ggplot(A[A$PFAA == PFAS_List[i],], aes(x = G_V/WB, y = log_ngkg_re,
                                   group = interaction(SppAlias, system),
                                   color = SppAlias,
                                   alpha = temperature))+
    geom_point(pch=".")+
    scale_fill_viridis_d(name=" ")+
    scale_color_viridis_d(name=" ")+
    theme_minimal()+
    geom_smooth(method = "lm", se = F)+
    guides(fill = guide_legend(nrow = 2, byrow = T)) +
    theme(legend.direction = "vertical", legend.box = "vertical")+
    theme(axis.text.x = element_text(size = 7))
    # facet_wrap(.~system, scales = "free")
  
  p.gd<-ggplot(A[A$PFAA == PFAS_List[i],], aes(x = G_D/WB, y = log_ngkg_re,
                                   group = interaction(SppAlias, system),
                                   color = SppAlias,
                                   alpha = temperature))+
    geom_point(pch=".")+
    scale_fill_viridis_d(name=" ")+
    scale_color_viridis_d(name=" ")+
    theme_minimal()+
    guides(fill = guide_legend(nrow = 2, byrow = T)) +
    theme(legend.direction = "vertical", legend.box = "vertical")+
    theme(axis.text.x = element_text(size = 7))+
    # facet_wrap(.~system, scales = "free")+
    geom_smooth(method = "lm", se = F)
  
  assign(paste("p.t_", PFAS_List[i], sep =""), p.t)
  assign(paste("p.bw_", PFAS_List[i], sep =""), p.bw)
  assign(paste("p.gv_", PFAS_List[i], sep =""), p.gv)
  assign(paste("p.gd_", PFAS_List[i], sep =""), p.gd)
  
}

cowplot::plot_grid(p.t_PFHxS + theme(legend.position = "none"),
                   p.t_PFOS + theme(legend.position = "none"),
                   p.t_PFNA + theme(legend.position = "none"),
                   p.t_PFOA + theme(legend.position = "none"),
                   labels = c("PFHxS", "PFOS", "PFNA",
                                      "PFOA", ""),
                   label_size = 8,
                   label_x = c(0.8, 0.8),
                   label_y = c(0.9, 0.9),
                   nrow = 2, ncol = 2)


```

<!-- ### The effects of ventilation rates on PFAA bioconcentrations -->

```{r g_v plot, eval = FALSE}

cowplot::plot_grid(p.gv_PFHxS + theme(legend.position = "none", axis.title = element_blank()),
                   p.gv_PFOS + theme(legend.position = "none", axis.title = element_blank()),
                   p.gv_PFNA + theme(legend.position = "none", axis.title.x = element_blank()),
                   p.gv_PFOA + theme(legend.position = "none", axis.title = element_blank()), 
                   legend, labels = c("PFHxS", "PFOS", "PFNA",
                                      "PFOA", ""),
                   label_size = 8,
                   label_x = c(0.8, 0.8),
                   label_y = c(0.9, 0.9),
                   nrow = 2, ncol = 2)


```

<!-- ### The effects of feeding rates on PFAA bioconcentrations -->

```{r g_d plot, eval = F}

cowplot::plot_grid(p.gd_PFHxS + theme(legend.position = "none", axis.title = element_blank()),
                   p.gd_PFOS + theme(legend.position = "none", axis.title = element_blank()),
                   p.gd_PFNA + theme(legend.position = "none", axis.title.x = element_blank()),
                   p.gd_PFOA + theme(legend.position = "none", axis.title = element_blank()), 
                   p.gd_PFOS + theme(legend.position = "none", axis.title.y = element_blank()), 
                   legend, labels = c("PFHxS", "PFOS", "PFNA",
                                      "PFOA", "PFOA", ""),
                   label_size = 8,
                   label_x = c(0.8, 0.8),
                   label_y = c(0.9, 0.9),
                   nrow = 5, ncol = 1)

```


### The variation in diet and water as a source of PFAA

```{r PART 3 SERDP REPORT figure 5 the proportion of PFAS from water and diet, fig.height=6.5, fig.width=8, fig.cap="Figure 6."}

# known diet
# uptake_avgO<-AO %>% 
#   select(spp_PFAA, system, SppAlias, PFAA, `Diet_up.`, `Sed_up.`, `Gill_up.`) %>% 
#   pivot_longer(!c(spp_PFAA, system, SppAlias, PFAA), names_to =  "uptake_route", values_to = "percent") %>% 
#   group_by(spp_PFAA, system, SppAlias, PFAA, uptake_route) %>% 
#   dplyr:::summarize(mean_perc = mean(percent), 
#                     sd_perc = sd(percent), 
#                     min_perc = min(percent),
#                     max_perc = max(percent)) 

# trophic transfer
uptake_avg<-A %>% 
  select(spp_PFAA, system, SppAlias, PFAA, `Diet_up.`, `Sed_up.`, `Gill_up.`) %>% 
  pivot_longer(!c(spp_PFAA, system, SppAlias, PFAA), names_to =  "uptake_route", values_to = "percent") %>% 
  group_by(spp_PFAA, system, SppAlias, PFAA, uptake_route) %>% 
  dplyr:::summarize(mean_perc = mean(percent), 
                    sd_perc = sd(percent), 
                    min_perc = min(percent),
                    max_perc = max(percent)) 


p1<-ggplot(data = uptake_avg[!c(uptake_avg$SppAlias == "Phy"), ], aes(y = mean_perc, x = uptake_route,
                      fill = uptake_route,
                      group = SppAlias, 
                      color = uptake_route, 
                      label = SppAlias))+
    facet_grid(system~PFAA)+
    # geom_point(pch = 21, size = 1, show.legend = FALSE,
    #            color = "black",
    #            stroke =0.3, position = position_dodge(width = 0.3))+
    theme_bw()+
    geom_hline(yintercept = 0.5, linewidth = 0.2, linetype = 2)+
    geom_bar(aes(y = mean_perc, x = uptake_route,
                      fill = uptake_route,
                      group = SppAlias, 
                      color = uptake_route, 
                      label = SppAlias),
             stat="identity",position = position_dodge(width = 0.5),
             width = 0.4, alpha=0.7)+
    geom_errorbar(mapping = aes(ymin = min_perc, ymax = max_perc), 
                  linewidth = 0.3, width = 0, position = position_dodge(width = 0.5), 
                  show.legend = F, color = "black")+
    # geom_line(linewidth = 0.2, position = position_dodge(width = 0.3))+
    scale_color_manual(breaks = c("Diet_up.", "Gill_up.", "Sed_up."), 
                       values = c("#007445", "#00C2FF", "#915801"),
                       label = c("Diet", "Gill", "Sediment"),
                       name = c(""))+
    scale_fill_manual(breaks = c("Diet_up.", "Gill_up.", "Sed_up."),
                      values = c("#007445", "#00C2FF", "#915801"),
                      label = c("Diet", "Gill", "Sediment"),
                      name = c(""))+
    # geom_text(mapping = aes(y = 1.1, x = uptake_route), size = 1.6,
    #           angle = 90, position = position_dodge(width = 0.5), color = "black")+
    ylim(0,1.3)

ggformat(p1, title = 'Trophic transfer of PFAA', x_title = 'Uptake Route', 
      y_title = 'Percent total PFAA uptake', print = F, size_text = 12)
p1<-p1+theme(legend.position = "top", axis.title.x = element_blank(),
             axis.text.x = element_blank(), 
             axis.ticks.x = element_line(linetype = 0))
ggsave(height = 5, width = 10, filename = here("Figures/Figure5_part3.png"))



```







